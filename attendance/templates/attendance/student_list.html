{% extends 'attendance/base.html' %}
{% load static %}

{% block title %}Student Management{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-people"></i> Student Management</h2>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
        <i class="bi bi-plus-circle"></i> Add Student
    </button>
</div>

<div class="card mb-3">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-search"></i> Search & Filter Students</h5>
    </div>
    <div class="card-body">
        <form method="GET" action="{% url 'student_list' %}" id="searchForm">
            <div class="row g-3">
                <!-- Search Type Selection -->
                <div class="col-md-3">
                    <label for="search_by" class="form-label"><small><strong>Search By:</strong></small></label>
                    <select class="form-select form-select-sm" name="search_by" id="search_by">
                        <option value="all" {% if search_by == 'all' %}selected{% endif %}>All Fields</option>
                        <option value="name" {% if search_by == 'name' %}selected{% endif %}>Name</option>
                        <option value="rfid_id" {% if search_by == 'rfid_id' %}selected{% endif %}>RFID ID</option>
                        <option value="student_id" {% if search_by == 'student_id' %}selected{% endif %}>Student ID</option>
                        <option value="course" {% if search_by == 'course' %}selected{% endif %}>Course</option>
                        <option value="section" {% if search_by == 'section' %}selected{% endif %}>Section</option>
                        <option value="email" {% if search_by == 'email' %}selected{% endif %}>Email</option>
                        <option value="adviser" {% if search_by == 'adviser' %}selected{% endif %}>Adviser</option>
                    </select>
                </div>
                
                <!-- Search Input -->
                <div class="col-md-4">
                    <label for="search" class="form-label"><small><strong>Search:</strong></small></label>
                    <input type="text" class="form-control form-control-sm" name="search" id="search" 
                           placeholder="Enter search term..." value="{{ search_query }}" autocomplete="off">
                </div>
                
                <!-- Course Filter -->
                <div class="col-md-2">
                    <label for="course" class="form-label"><small><strong>Course:</strong></small></label>
                    <select class="form-select form-select-sm" name="course" id="course">
                        <option value="">All Courses</option>
                        {% for course in filter_courses %}
                        <option value="{{ course.id }}" {% if course_filter == course.id|stringformat:"s" or course_filter|lower == course.code|lower or course_filter|lower == course.name|lower %}selected{% endif %}>{{ course.code }} - {{ course.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Adviser Filter -->
                <div class="col-md-2">
                    <label for="adviser" class="form-label"><small><strong>Adviser:</strong></small></label>
                    <select class="form-select form-select-sm" name="adviser" id="adviser">
                        <option value="">All Advisers</option>
                        {% for adviser in filter_advisers %}
                        <option value="{{ adviser.id }}" {% if adviser_filter == adviser.id|stringformat:"s" or adviser_filter|lower == adviser.name|lower %}selected{% endif %}>{{ adviser.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Action Buttons -->
                <div class="col-md-1">
                    <label class="form-label"><small>&nbsp;</small></label>
                    <div class="d-grid gap-1">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="bi bi-search"></i> Search
                        </button>
                        <a href="{% url 'student_list' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-x-circle"></i> Clear
                        </a>
                    </div>
                </div>
            </div>
        </form>
        
        {% if search_query or course_filter or adviser_filter %}
        <div class="mt-3">
            <small class="text-muted">
                <strong>Active Filters:</strong>
                {% if search_query %}
                    <span class="badge bg-info text-dark">Search: "{{ search_query }}" ({{ search_by }})</span>
                {% endif %}
                {% if course_filter %}
                    <span class="badge bg-info text-dark">Course: {{ course_filter }}</span>
                {% endif %}
                {% if adviser_filter %}
                    <span class="badge bg-info text-dark">Adviser: {{ adviser_filter }}</span>
                {% endif %}
                <span class="badge bg-success">Results: {{ total_count }} student{{ total_count|pluralize }}</span>
            </small>
        </div>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>RFID ID</th>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Course</th>
                        <th>Section</th>
                        <th>Email</th>
                        <th>Adviser</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr id="student-row-{{ student.id }}" data-student-id="{{ student.id }}">
                        <td><code>{{ student.rfid_id }}</code></td>
                        <td>{{ student.student_id|default:"<span class='text-muted'>N/A</span>" }}</td>
                        <td><strong>{{ student.name }}</strong></td>
                        <td>{% if student.course %}{{ student.course.code }} - {{ student.course.name }}{% else %}<span class='text-muted'>N/A</span>{% endif %}</td>
                        <td>{% if student.section %}<span class="badge bg-info">{{ student.section.name }} ({{ student.section.code }})</span>{% else %}<span class='text-muted'>N/A</span>{% endif %}</td>
                        <td>{{ student.email }}</td>
                        <td>{% if student.adviser %}{{ student.adviser.name }}{% else %}<span class='text-muted'>N/A</span>{% endif %}</td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{% url 'student_edit' student.id %}{{ query_string }}" class="btn btn-outline-primary" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="{% url 'student_summary_detail' student.id %}" class="btn btn-outline-info" title="View Summary">
                                    <i class="bi bi-graph-up"></i>
                                </a>
                                <form method="POST" action="{% url 'student_delete' student.id %}" class="d-inline delete-form" data-message="Are you sure you want to delete {{ student.name }}?">
                                    {% csrf_token %}
                                    {% if adviser_filter %}
                                        <input type="hidden" name="adviser" value="{{ adviser_filter }}">
                                    {% endif %}
                                    {% if course_filter %}
                                        <input type="hidden" name="course" value="{{ course_filter }}">
                                    {% endif %}
                                    {% if search_query %}
                                        <input type="hidden" name="search" value="{{ search_query }}">
                                    {% endif %}
                                    {% if search_by and search_by != 'all' %}
                                        <input type="hidden" name="search_by" value="{{ search_by }}">
                                    {% endif %}
                                    <button type="submit" class="btn btn-outline-danger" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="text-muted">
                                <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                                <p class="mt-2 mb-0">No students found.</p>
                                {% if search_query or course_filter or adviser_filter %}
                                <small>Try adjusting your search filters.</small>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                Showing {{ students.start_index|default:0 }} to {{ students.end_index|default:0 }} of {{ total_count }} students
            </div>
            <div>
                <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#importModal">
                    <i class="bi bi-upload"></i> Import CSV
                </button>
                <a href="{% url 'student_export_csv' %}" class="btn btn-outline-success">
                    <i class="bi bi-download"></i> Export CSV
                </a>
            </div>
        </div>
        
        {% if students.has_other_pages %}
        <nav aria-label="Page navigation" class="mt-3">
            <ul class="pagination justify-content-center">
                {% if students.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ students.previous_page_number }}&search={{ search_query }}&search_by={{ search_by }}&course={{ course_filter }}&adviser={{ adviser_filter }}">Previous</a>
                </li>
                {% endif %}
                <li class="page-item active"><span class="page-link">Page {{ students.number }} of {{ students.paginator.num_pages }}</span></li>
                {% if students.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ students.next_page_number }}&search={{ search_query }}&search_by={{ search_by }}&course={{ course_filter }}&adviser={{ adviser_filter }}">Next</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Add Student Modal -->
<div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addStudentModalLabel">
                    <i class="bi bi-person-plus"></i> Add Student
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'student_add' %}" id="addStudentForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="modal_rfid_id" class="form-label">RFID ID *</label>
                            <input type="text" class="form-control" id="modal_rfid_id" name="rfid_id" required>
                        </div>
                        <div class="col-md-6">
                            <label for="modal_student_id" class="form-label">Student ID</label>
                            <input type="text" class="form-control" id="modal_student_id" name="student_id">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="modal_name" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="modal_name" name="name" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="modal_course" class="form-label">Course *</label>
                            <select class="form-select" id="modal_course" name="course" required>
                                <option value="">-- Select Course --</option>
                                {% if all_courses %}
                                    {% for course in all_courses %}
                                    <option value="{{ course.id }}">{{ course.code }} - {{ course.name }}</option>
                                    {% endfor %}
                                {% else %}
                                    <option value="" disabled>No courses available. Please contact administrator.</option>
                                {% endif %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="modal_section" class="form-label">Section *</label>
                            <select class="form-select" id="modal_section" name="section" required>
                                <option value="">-- Select Section --</option>
                                {% if sections %}
                                    {% for section in sections %}
                                    <option value="{{ section.id }}">{{ section.name }} ({{ section.code }})</option>
                                    {% endfor %}
                                {% else %}
                                    <option value="" disabled>No sections available. Please create a section first.</option>
                                {% endif %}
                            </select>
                            <small class="form-text text-muted">
                                <a href="{% url 'section_list' %}" target="_blank">Manage Sections</a>
                            </small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="modal_email" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="modal_email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="modal_adviser" class="form-label">Adviser</label>
                        <select class="form-select" id="modal_adviser" name="adviser">
                            <option value="">-- No Adviser --</option>
                            {% if all_advisers %}
                                {% for adviser in all_advisers %}
                                <option value="{{ adviser.id }}">{{ adviser.name }} ({{ adviser.email }})</option>
                                {% endfor %}
                            {% else %}
                                <option value="" disabled>No advisers available.</option>
                            {% endif %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Save Student
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import CSV Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Students from CSV</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% url 'student_import_csv' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <p>CSV file should have the following columns:</p>
                    <ul>
                        <li><strong>rfid_id</strong> (required)</li>
                        <li><strong>name</strong> (required)</li>
                        <li>student_id</li>
                        <li>course</li>
                        <li>email</li>
                        <li>adviser</li>
                    </ul>
                    <div class="mb-3">
                        <label for="csv_file" class="form-label">Select CSV File:</label>
                        <input type="file" class="form-control" id="csv_file" name="csv_file" accept=".csv" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Import</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Focus search input on page load if no search query
    {% if not search_query %}
    const searchInput = document.getElementById('search');
    if (searchInput) {
        searchInput.focus();
    }
    {% endif %}
    
    // Highlight newly added student if highlight parameter is present
    const urlParams = new URLSearchParams(window.location.search);
    const highlightStudentId = urlParams.get('highlight');
    if (highlightStudentId) {
        const studentRow = document.getElementById('student-row-' + highlightStudentId);
        if (studentRow) {
            // Add highlight class
            studentRow.classList.add('table-success');
            studentRow.style.transition = 'background-color 0.3s ease';
            
            // Scroll to the row
            studentRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Remove highlight after 3 seconds
            setTimeout(function() {
                studentRow.classList.remove('table-success');
            }, 3000);
            
            // Remove highlight parameter from URL without reload
            urlParams.delete('highlight');
            const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
            window.history.replaceState({}, '', newUrl);
        }
    }
    
    // Enter key to submit search
    const searchForm = document.getElementById('searchForm');
    if (searchForm) {
        const searchInput = document.getElementById('search');
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchForm.submit();
                }
            });
        }
    }
    
    // Handle delete form confirmations
    document.querySelectorAll('.delete-form').forEach(function(form) {
        const message = form.getAttribute('data-message') || 'Are you sure?';
        form.addEventListener('submit', function(e) {
            if (!confirm(message)) {
                e.preventDefault();
            }
        });
    });
    
    // Handle add student modal form submission
    const addStudentForm = document.getElementById('addStudentForm');
    if (addStudentForm) {
        addStudentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get submit button and disable it to prevent double submission
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton ? submitButton.innerHTML : '';
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
            }
            
            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                // Check content type to determine if it's JSON or HTML
                const contentType = response.headers.get('content-type');
                
                // Handle JSON responses (from AJAX-aware view)
                if (contentType && contentType.includes('application/json')) {
                    return response.json().then(data => {
                        if (data.success) {
                            // Success - close modal and redirect/reload
                            const modal = bootstrap.Modal.getInstance(document.getElementById('addStudentModal'));
                            if (modal) {
                                modal.hide();
                            }
                            // Redirect to the URL provided or reload
                            if (data.redirect_url) {
                                setTimeout(() => {
                                    window.location.href = data.redirect_url;
                                }, 300);
                            } else {
                                setTimeout(() => {
                                    window.location.reload();
                                }, 300);
                            }
                        } else {
                            // Show error message
                            alert('Error: ' + (data.error || 'An error occurred while adding the student.'));
                            // Re-enable submit button
                            if (submitButton) {
                                submitButton.disabled = false;
                                submitButton.innerHTML = originalButtonText;
                            }
                        }
                    });
                }
                
                // Handle redirects (non-AJAX responses)
                if (response.redirected) {
                    // Close modal before redirecting
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addStudentModal'));
                    if (modal) {
                        modal.hide();
                    }
                    window.location.href = response.url;
                    return;
                }
                
                // Check if response is ok
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Fallback to HTML parsing for non-JSON responses
                return response.text();
            })
            .then(html => {
                if (html && typeof html === 'string') {
                    // If there are errors, show them
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const errorMessages = doc.querySelectorAll('.alert-danger, .errorlist');
                    if (errorMessages.length > 0) {
                        const errorText = Array.from(errorMessages).map(el => el.textContent.trim()).filter(text => text).join('\n');
                        alert('Error: ' + errorText);
                        // Re-enable submit button
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.innerHTML = originalButtonText;
                        }
                    } else {
                        // Success - close modal and reload page
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addStudentModal'));
                        if (modal) {
                            modal.hide();
                        }
                        // Small delay to allow modal to close smoothly
                        setTimeout(() => {
                            window.location.reload();
                        }, 300);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while adding the student: ' + error.message);
                // Re-enable submit button on error
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                }
            });
        });
    }
    
    // Load dropdown data when modal opens and reset form when closed
    const addStudentModal = document.getElementById('addStudentModal');
    if (addStudentModal) {
        // Reset form when modal is hidden
        addStudentModal.addEventListener('hidden.bs.modal', function() {
            const form = document.getElementById('addStudentForm');
            if (form) {
                form.reset();
            }
        });
        
        // Load dropdowns when modal is shown
        addStudentModal.addEventListener('show.bs.modal', function() {
            // Store original server-side options as fallback
            const courseSelect = document.getElementById('modal_course');
            const sectionSelect = document.getElementById('modal_section');
            const adviserSelect = document.getElementById('modal_adviser');
            
            const originalCourseOptions = courseSelect ? courseSelect.innerHTML : '';
            const originalSectionOptions = sectionSelect ? sectionSelect.innerHTML : '';
            const originalAdviserOptions = adviserSelect ? adviserSelect.innerHTML : '';
            
            // Load courses
            if (courseSelect) {
                // Only show loading if there are no existing options
                if (courseSelect.options.length <= 1) {
                    courseSelect.disabled = true;
                    courseSelect.innerHTML = '<option value="">Loading courses...</option>';
                }
                fetch('{% url "api_courses" %}', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    credentials: 'same-origin'
                })
                    .then(response => {
                        if (!response.ok) {
                            // Try to parse error response
                            return response.json().then(errorData => {
                                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                            }).catch(() => {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Courses API response:', data);
                        if (data.success && data.courses && data.courses.length > 0) {
                            courseSelect.innerHTML = '<option value="">-- Select Course --</option>';
                            data.courses.forEach(course => {
                                const option = document.createElement('option');
                                option.value = course.id;
                                option.textContent = course.display || `${course.code} - ${course.name}`;
                                courseSelect.appendChild(option);
                            });
                            courseSelect.disabled = false;
                            // Auto-select if only one course
                            if (data.courses.length === 1) {
                                courseSelect.selectedIndex = 1;
                            }
                        } else {
                            // If API returns no data, keep original server-side options
                            if (originalCourseOptions && courseSelect.options.length <= 1) {
                                courseSelect.innerHTML = originalCourseOptions;
                            } else {
                                courseSelect.innerHTML = '<option value="">No courses available</option>';
                            }
                            courseSelect.disabled = false;
                            console.warn('No courses returned from API');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading courses:', error);
                        // On error, restore original server-side options if available
                        if (originalCourseOptions && courseSelect.options.length <= 1) {
                            courseSelect.innerHTML = originalCourseOptions;
                        } else {
                            courseSelect.innerHTML = `<option value="">Error: ${error.message}</option>`;
                        }
                        courseSelect.disabled = false;
                    });
            }
            
            // Load sections
            if (sectionSelect) {
                // Only show loading if there are no existing options
                if (sectionSelect.options.length <= 1) {
                    sectionSelect.disabled = true;
                    sectionSelect.innerHTML = '<option value="">Loading sections...</option>';
                }
                fetch('{% url "api_sections" %}', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    credentials: 'same-origin'
                })
                    .then(response => {
                        if (!response.ok) {
                            // Try to parse error response
                            return response.json().then(errorData => {
                                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                            }).catch(() => {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Sections API response:', data);
                        if (data.success && data.sections && data.sections.length > 0) {
                            sectionSelect.innerHTML = '<option value="">-- Select Section --</option>';
                            data.sections.forEach(section => {
                                const option = document.createElement('option');
                                option.value = section.id;
                                option.textContent = section.display || `${section.name} (${section.code})`;
                                sectionSelect.appendChild(option);
                            });
                            sectionSelect.disabled = false;
                        } else {
                            // If API returns no data, keep original server-side options
                            if (originalSectionOptions && sectionSelect.options.length <= 1) {
                                sectionSelect.innerHTML = originalSectionOptions;
                            } else {
                                sectionSelect.innerHTML = '<option value="">No sections available</option>';
                            }
                            sectionSelect.disabled = false;
                            console.warn('No sections returned from API');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading sections:', error);
                        // On error, restore original server-side options if available
                        if (originalSectionOptions && sectionSelect.options.length <= 1) {
                            sectionSelect.innerHTML = originalSectionOptions;
                        } else {
                            sectionSelect.innerHTML = `<option value="">Error: ${error.message}</option>`;
                        }
                        sectionSelect.disabled = false;
                    });
            }
            
            // Load advisers
            if (adviserSelect) {
                // Only show loading if there are no existing options
                if (adviserSelect.options.length <= 1) {
                    adviserSelect.disabled = true;
                    adviserSelect.innerHTML = '<option value="">Loading advisers...</option>';
                }
                fetch('{% url "api_advisers" %}', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    credentials: 'same-origin'
                })
                    .then(response => {
                        if (!response.ok) {
                            // Try to parse error response
                            return response.json().then(errorData => {
                                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                            }).catch(() => {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Advisers API response:', data);
                        if (data.success && data.advisers && data.advisers.length > 0) {
                            adviserSelect.innerHTML = '<option value="">-- No Adviser --</option>';
                            data.advisers.forEach(adviser => {
                                const option = document.createElement('option');
                                option.value = adviser.id;
                                option.textContent = adviser.display || `${adviser.name} (${adviser.email})`;
                                adviserSelect.appendChild(option);
                            });
                            adviserSelect.disabled = false;
                            
                            // Auto-select current adviser if viewing their own filter
                            {% if current_adviser_id %}
                            const currentAdviserId = {{ current_adviser_id }};
                            const urlParams = new URLSearchParams(window.location.search);
                            const adviserFilter = urlParams.get('adviser');
                            
                            // If filtering by current adviser (by ID or name), auto-select them
                            if (adviserFilter) {
                                try {
                                    const filterAdviserId = parseInt(adviserFilter);
                                    if (filterAdviserId === currentAdviserId) {
                                        adviserSelect.value = currentAdviserId;
                                    }
                                } catch (e) {
                                    // If adviser filter is a name, check if it matches current adviser
                                    {% if adviser_name %}
                                    if (adviserFilter.toLowerCase() === '{{ adviser_name|lower }}') {
                                        adviserSelect.value = currentAdviserId;
                                    }
                                    {% endif %}
                                }
                            } else if (currentAdviserId) {
                                // If no filter but user is an adviser, auto-select themselves
                                adviserSelect.value = currentAdviserId;
                            }
                            {% endif %}
                        } else {
                            // If API returns no data, keep original server-side options
                            if (originalAdviserOptions && adviserSelect.options.length <= 1) {
                                adviserSelect.innerHTML = originalAdviserOptions;
                            } else {
                                adviserSelect.innerHTML = '<option value="">No advisers available</option>';
                            }
                            adviserSelect.disabled = false;
                            console.warn('No advisers returned from API');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading advisers:', error);
                        // On error, restore original server-side options if available
                        if (originalAdviserOptions && adviserSelect.options.length <= 1) {
                            adviserSelect.innerHTML = originalAdviserOptions;
                        } else {
                            adviserSelect.innerHTML = `<option value="">Error: ${error.message}</option>`;
                        }
                        adviserSelect.disabled = false;
                    });
            }
        });
    }
});
</script>
{% endblock %}
