{% extends 'attendance/base.html' %}
{% load static %}
{% block title %}Student Management{% endblock %}

{% block extra_css %}
<style>
    .card-header h5 {
        font-size: 1.1rem;
        font-weight: 600;
    }
    .table > thead {
        background-color: #f8fafc;
    }
    .table > thead > tr > th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        color: #64748b;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e2e8f0;
    }
    .table > tbody > tr > td {
        padding: 1rem 1.5rem;
        vertical-align: middle;
    }
    .pagination .page-item .page-link {
        border-radius: 0.5rem;
        margin: 0 0.25rem;
        border: none;
        color: #475569;
    }
    .pagination .page-item.active .page-link {
        background-color: var(--primary-blue);
        border-color: var(--primary-blue);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2), 0 2px 4px -2px rgba(37, 99, 235, 0.12);
    }
    .pagination .page-item.disabled .page-link {
        color: #9ca3af;
    }
    .text-ellipsis {
        max-width: 220px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: inline-block;
        vertical-align: middle;
    }
    .filter-card .card-body {
        padding: 1rem;
    }
    .filter-card .form-label {
        font-weight: 600;
    }
    .card .card-header h5 {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .table > tbody > tr > td,
    .table > thead > tr > th {
        vertical-align: middle;
    }
    .btn-group .btn {
        padding: .35rem .5rem;
    }
    .badge.bg-info {
        font-size: .85rem;
    }

    /* Student avatar and info */
    .student-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .student-avatar {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: .4rem;
        flex-shrink: 0;
    }
    .student-name {
        font-weight: 700;
        letter-spacing: .02em;
    }
    .student-name-link {
        transition: color 0.2s ease;
    }
    .student-name-link:hover {
        color: var(--primary-blue) !important;
        text-decoration: underline !important;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %} 
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-people"></i> Student Management</h2>
    <div class="btn-group">
        {% if request.user.is_staff or is_adviser %}
        <div class="btn-group">
            <button type="button" class="btn btn-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-check2-square"></i> Bulk Actions
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#bulkMarkAttendanceModal" data-status="PRESENT">Mark Filtered as Present</a></li>
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#bulkMarkAttendanceModal" data-status="ABSENT">Mark Filtered as Absent</a></li>
            </ul>
        </div>
        {% endif %}
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
        <i class="bi bi-plus-circle"></i> Add Student
    </button>
    </div>
</div>

<div class="card filter-card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-funnel"></i> Search & Filter</h5>
    </div>
    <div class="card-body">
        <form method="GET" action="{% url 'student_list' %}" id="searchForm">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="search_by" class="form-label">Search By</label>
                    <select class="form-select" name="search_by" id="search_by">
                        <option value="all" {% if search_by == 'all' %}selected{% endif %}>All Fields</option>
                        <option value="name" {% if search_by == 'name' %}selected{% endif %}>Name</option>
                        <option value="rfid_id" {% if search_by == 'rfid_id' %}selected{% endif %}>RFID ID</option>
                        <option value="student_id" {% if search_by == 'student_id' %}selected{% endif %}>Student ID</option>
                        <option value="course" {% if search_by == 'course' %}selected{% endif %}>Course</option>
                        <option value="section" {% if search_by == 'section' %}selected{% endif %}>Section</option>
                        <option value="email" {% if search_by == 'email' %}selected{% endif %}>Email</option>
                    </select>
                </div>
                <div class="col-md-9">
                    <label for="search" class="form-label">Search Term</label>
                    <input type="text" class="form-control" name="search" id="search" placeholder="Enter search term..." value="{{ search_query }}" autocomplete="off">
                </div>
                <div class="col-md-4">
                    <label for="course" class="form-label">Course</label>
                    <select class="form-select" name="course" id="course">
                        <option value="">All Courses</option>
                        {% for course in filter_courses %}
                        <option value="{{ course.id }}" {% if course_filter == course.id|stringformat:"s" %}selected{% endif %}>{{ course.code }} - {{ course.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="section" class="form-label">Section</label>
                    <select class="form-select" name="section" id="section">
                        <option value="">All Sections</option>
                        {% for section in filter_sections %}
                        <option value="{{ section.id }}" {% if section_filter == section.id|stringformat:"s" %}selected{% endif %}>{{ section.name }} ({{ section.code }})</option>
                        {% endfor %}
                    </select>
                </div>
                {% if not current_adviser_id %}
                <div class="col-md-4">
                    <label for="adviser" class="form-label">Adviser</label>
                    <select class="form-select" name="adviser" id="adviser">
                        <option value="">All Advisers</option>
                        {% for adviser in all_advisers %}
                        <option value="{{ adviser.id }}" {% if adviser_filter == adviser.id|stringformat:"s" %}selected{% endif %}>{{ adviser.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                <div class="col-12 text-end">
                    <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> Search</button>
                    <a href="{% url 'student_list' %}" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> Clear</a>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card students-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Student List</h5>
        <span class="badge bg-secondary">{{ total_count }} student{{ total_count|pluralize }}</span>
    </div>
    <div class="card-body">
        <div class="table-wrapper">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Student ID</th>
                        <th>RFID</th>
                        <th>Course</th>
                        <th>Section</th>
                        <th>Adviser</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr id="student-row-{{ student.id }}" data-student-id="{{ student.id }}">
                        <td>
                            <div class="student-info">
                                <img class="student-avatar rounded" src="{% if student.profile_picture %}{{ student.profile_picture.url }}{% else %}{% static 'attendance/img/default_profile_picture.jpeg' %}{% endif %}" alt="Profile of {{ student.name }}" loading="lazy" onerror="this.onerror=null;this.src='{% static 'attendance/img/default_profile_picture.jpeg' %}';">
                                <div>
                                    <div class="student-name">
                                        <a href="#" class="text-decoration-none student-name-link" 
                                           data-student-id="{{ student.id }}" 
                                           data-student-name="{{ student.name }}"
                                           data-bs-toggle="modal" 
                                           data-bs-target="#studentSubjectsModal"
                                           style="color: inherit;">
                                            {{ student.name|upper }}
                                        </a>
                                    </div>
                                    <div class="student-meta">{{ student.email }}</div>
                                </div>
                            </div>
                        </td>
                        <td>{{ student.student_id|default:"N/A" }}</td>
                        <td><code>{{ student.rfid_id }}</code></td>
                        <td>
                            {% if student.course %}
                                <div class="fw-medium">{{ student.course.code }}</div>
                                <small class="text-muted">{{ student.course.name }}</small>
                            {% else %}
                                <span class='text-muted'>N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if student.section %}
                                <span class="badge bg-info text-dark">{{ student.section.name }}</span>
                            {% else %}
                                <span class='text-muted'>N/A</span>
                            {% endif %}
                        </td>
                        <td>{{ student.adviser.name|default:"N/A" }}</td>
                        <td>
                            <div class="action-buttons btn-group" role="group">
                                <a href="{% url 'student_edit' student.id %}{{ query_string }}" class="btn btn-outline-primary" title="Edit"><i class="bi bi-pencil"></i></a>
                                <a href="{% url 'student_summary_detail' student.id %}" class="btn btn-outline-info" title="View Summary"><i class="bi bi-graph-up"></i></a>
                                <form method="POST" action="{% url 'student_list' %}" class="d-inline make-absent-form" data-message="Mark {{ student.name|upper }} absent for today?">
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="make_absent">
                                    <input type="hidden" name="student_id" value="{{ student.id }}">
                                    <button type="submit" class="btn btn-outline-warning" title="Mark Absent"><i class="bi bi-dash-circle"></i></button>
                                </form>
                                <form method="POST" action="{% url 'student_delete' student.id %}" class="d-inline delete-form" data-message="Are you sure you want to delete {{ student.name|upper }}?">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-danger" title="Delete"><i class="bi bi-trash"></i></button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="text-muted">
                                <i class="bi bi-inbox" style="font-size: 2.5rem;"></i>
                                <p class="mt-2 mb-1 fw-bold">No students found.</p>
                                <small>Try adjusting your search filters.</small>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer bg-white d-flex justify-content-between align-items-center flex-wrap gap-3 py-3">
        <div class="text-muted small">
            Showing {{ students.start_index|default:0 }} to {{ students.end_index|default:0 }} of {{ total_count }} students
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#importModal"><i class="bi bi-upload"></i> Import CSV</button>
            <a href="{% url 'student_export_csv' %}" class="btn btn-outline-success"><i class="bi bi-download"></i> Export CSV</a>
        </div>
        {% if students.has_other_pages %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mb-0">
                {% if students.has_previous %}
                <li class="page-item"><a class="page-link" href="?page=1&{{ query_string|slice:'1:' }}">First</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ students.previous_page_number }}&{{ query_string|slice:'1:' }}">Previous</a></li>
                {% endif %}
                <li class="page-item active" aria-current="page"><span class="page-link">Page {{ students.number }} of {{ students.paginator.num_pages }}</span></li>
                {% if students.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ students.next_page_number }}&{{ query_string|slice:'1:' }}">Next</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ students.paginator.num_pages }}&{{ query_string|slice:'1:' }}">Last</a></li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Add Student Modal -->
<div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addStudentModalLabel">
                    <i class="bi bi-person-plus"></i> Add Student
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'student_add' %}" id="addStudentForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="modal_rfid_id" class="form-label">RFID ID *</label>
                            <input type="text" class="form-control" id="modal_rfid_id" name="rfid_id" required>
                        </div>
                        <div class="col-md-6">
                            <label for="modal_student_id" class="form-label">Student ID</label>
                            <input type="text" class="form-control" id="modal_student_id" name="student_id">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="modal_name" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="modal_name" name="name" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="modal_course" class="form-label">Course *</label>
                            <select class="form-select" id="modal_course" name="course" required>
                                <option value="">-- Select Course --</option>
                                {% if all_courses %}
                                    {% for course in all_courses %}
                                    <option value="{{ course.id }}">{{ course.code }} - {{ course.name }}</option>
                                    {% endfor %}
                                {% else %}
                                    <option value="" disabled>No courses available. Please contact administrator.</option>
                                {% endif %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="modal_section" class="form-label">Section *</label>
                            <select class="form-select" id="modal_section" name="section" required>
                                <option value="">-- Select Section --</option>
                                {% if sections %}
                                    {% for section in sections %}
                                    <option value="{{ section.id }}">{{ section.name }} ({{ section.code }})</option>
                                    {% endfor %}
                                {% else %}
                                    <option value="" disabled>No sections available. Please create a section first.</option>
                                {% endif %}
                            </select>
                            <small class="form-text text-muted">
                                <a href="{% url 'section_list' %}" target="_blank">Manage Sections</a>
                            </small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="modal_email" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="modal_email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="modal_adviser" class="form-label">Adviser</label>
                        <select class="form-select" id="modal_adviser" name="adviser">
                            <option value="">-- No Adviser --</option>
                            {% if all_advisers %}
                                {% for adviser in all_advisers %}
                                <option value="{{ adviser.id }}">{{ adviser.name }} ({{ adviser.email }})</option>
                                {% endfor %}
                            {% else %}
                                <option value="" disabled>No advisers available.</option>
                            {% endif %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Save Student
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import CSV Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Students from CSV</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% url 'student_import_csv' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <p>CSV file should have the following columns:</p>
                    <ul>
                        <li><strong>rfid_id</strong> (required)</li>
                        <li><strong>name</strong> (required)</li>
                        <li>student_id</li>
                        <li>course</li>
                        <li>email</li>
                        <li>adviser</li>
                    </ul>
                    <div class="mb-3">
                        <label for="csv_file" class="form-label">Select CSV File:</label>
                        <input type="file" class="form-control" id="csv_file" name="csv_file" accept=".csv" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Import</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Make Absent Modal -->
<div class="modal fade" id="makeAbsentModal" tabindex="-1" aria-labelledby="makeAbsentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="makeAbsentModalLabel">Mark Student as Absent</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'student_list' %}" id="makeAbsentForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="make_absent">
                <input type="hidden" id="absent_student_id" name="student_id">
                <div class="modal-body">
                    <p>Select the subject(s) to mark the student as absent for today.</p>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="select_all_subjects">
                        <label class="form-check-label" for="select_all_subjects">
                            <strong>Select All Subjects</strong>
                        </label>
                    </div>
                    <div id="absent-subjects-list" class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                        <!-- Subjects will be loaded here by JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Mark Absent</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Mark Attendance Modal -->
<div class="modal fade" id="bulkMarkAttendanceModal" tabindex="-1" aria-labelledby="bulkMarkAttendanceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkMarkAttendanceModalLabel">Bulk Mark Attendance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'student_list' %}" id="bulkMarkAttendanceForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="bulk_mark_attendance">
                <input type="hidden" id="bulk_attendance_status" name="status">
                <div class="modal-body">
                    <p>You are about to mark all <strong>{{ total_count }}</strong> filtered students as <strong id="bulk_status_display"></strong> for the selected subject.</p>
                    <div class="mb-3">
                        <label for="bulk_subject_id" class="form-label">Subject *</label>
                        <select class="form-select" id="bulk_subject_id" name="subject_id" required>
                            <option value="">-- Select Subject --</option>
                            {% for subject in subjects_for_adviser %}
                            <option value="{{ subject.id }}">{{ subject.code }} - {{ subject.name }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">This action will apply to all students matching the current filters for the selected subject.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Confirm</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Student Subjects Modal -->
<div class="modal fade" id="studentSubjectsModal" tabindex="-1" aria-labelledby="studentSubjectsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="studentSubjectsModalLabel">
                    <i class="bi bi-book"></i> Enrolled Subjects
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6 class="fw-bold" id="student-name-display">Loading...</h6>
                </div>
                <div class="mb-3 d-none" id="semester-filter-container">
                    <label for="semester-filter" class="form-label">Filter by Semester:</label>
                    <select class="form-select" id="semester-filter">
                        <option value="">All Semesters</option>
                    </select>
                </div>
                <div id="subjects-loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading subjects...</p>
                </div>
                <div id="subjects-list" class="d-none">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Subject Code</th>
                                    <th>Subject Name</th>
                                    <th>Semester</th>
                                    <th>Academic Year</th>
                                    <th>Schedule Today</th>
                                </tr>
                            </thead>
                            <tbody id="subjects-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="subjects-error" class="alert alert-danger d-none" role="alert">
                    <i class="bi bi-exclamation-triangle"></i> <span id="error-message">Failed to load subjects.</span>
                </div>
                <div id="subjects-empty" class="text-center py-4 d-none">
                    <i class="bi bi-inbox" style="font-size: 2.5rem; color: #6c757d;"></i>
                    <p class="mt-2 text-muted">This student is not enrolled in any subjects.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Focus search input on page load if no search query
    {% if not search_query %}
    const searchInput = document.getElementById('search');
    if (searchInput) {
        searchInput.focus();
    }
    {% endif %}
    
    // Highlight newly added student if highlight parameter is present
    const urlParams = new URLSearchParams(window.location.search);
    const highlightStudentId = urlParams.get('highlight');
    if (highlightStudentId) {
        const studentRow = document.getElementById('student-row-' + highlightStudentId);
        if (studentRow) {
            // Add highlight class
            studentRow.classList.add('table-success');
            studentRow.style.transition = 'background-color 0.3s ease';
            
            // Scroll to the row
            studentRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Remove highlight after 3 seconds
            setTimeout(function() {
                studentRow.classList.remove('table-success');
            }, 3000);
            
            // Remove highlight parameter from URL without reload
            urlParams.delete('highlight');
            const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
            window.history.replaceState({}, '', newUrl);
        }
    }
    
    // Enter key to submit search
    const searchForm = document.getElementById('searchForm');
    if (searchForm) {
        const searchInput = document.getElementById('search');
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchForm.submit();
                }
            });
        }
    }
    
    // Handle delete form confirmations
    document.querySelectorAll('.delete-form').forEach(function(form) {
        const message = form.getAttribute('data-message') || 'Are you sure?';
        form.addEventListener('submit', function(e) {
            if (!confirm(message)) {
                e.preventDefault();
            }
        });
    });

    // Intercept make-absent forms to show subject selection modal
    const studentSubjectsApiTemplate = '{% url "api_student_subjects" 0 %}';
    document.querySelectorAll('.make-absent-form').forEach(function(form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const studentIdInput = form.querySelector('input[name="student_id"]');
            if (!studentIdInput) return;
            const studentId = studentIdInput.value;
            const absentStudentIdField = document.getElementById('absent_student_id');
            absentStudentIdField.value = studentId;

            const listContainer = document.getElementById('absent-subjects-list');
            listContainer.innerHTML = '<div class="text-muted">Loading subjectsâ€¦</div>';

            const apiUrl = studentSubjectsApiTemplate.replace('/0/', '/' + studentId + '/');
            fetch(apiUrl, {
                method: 'GET',
                headers: { 'Accept': 'application/json' },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) throw response;
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    listContainer.innerHTML = '<div class="text-danger">Error loading subjects.</div>';
                    return;
                }

                listContainer.innerHTML = '';
                data.subjects.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'form-check mb-1 p-2';
                    if (s.has_schedule_today) div.classList.add('bg-warning', 'bg-opacity-10');
                    div.innerHTML = `
                        <input class="form-check-input subject-checkbox" type="checkbox" name="subject_ids" value="${s.id}" id="subject_${s.id}">
                        <label class="form-check-label" for="subject_${s.id}">${s.display} ${s.has_schedule_today ? '<span class="badge bg-warning text-dark ms-2">Today</span>' : ''}</label>
                    `;
                    listContainer.appendChild(div);
                });

                // Populate hidden filter inputs into the modal form so redirects preserve current filters
                const makeAbsentFormEl = document.getElementById('makeAbsentForm');
                if (makeAbsentFormEl) {
                    // Remove any existing filter inputs first
                    ['adviser','course','search','search_by'].forEach(name => {
                        const old = makeAbsentFormEl.querySelector('input[name="' + name + '"]');
                        if (old) old.remove();
                    });
                    // Read current URL params
                    const currentParams = new URLSearchParams(window.location.search);
                    ['adviser','course','search','search_by'].forEach(name => {
                        const val = currentParams.get(name);
                        if (val !== null && val !== undefined && val !== '') {
                            const inp = document.createElement('input');
                            inp.type = 'hidden';
                            inp.name = name;
                            inp.value = val;
                            makeAbsentFormEl.appendChild(inp);
                        }
                    });
                }

                // Show modal
                const modalEl = document.getElementById('makeAbsentModal');
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            })
            .catch(err => {
                console.error('Error fetching student subjects:', err);
                listContainer.innerHTML = '<div class="text-danger">Failed to load subjects.</div>';
                const modalEl = document.getElementById('makeAbsentModal');
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            });
        });
    });

    // Handle bulk attendance modal
    const bulkModal = document.getElementById('bulkMarkAttendanceModal');
    if (bulkModal) {
        bulkModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const status = button.getAttribute('data-status');
            const modalTitle = bulkModal.querySelector('.modal-title');
            const statusDisplay = bulkModal.querySelector('#bulk_status_display');
            const statusInput = bulkModal.querySelector('#bulk_attendance_status');
            const submitButton = bulkModal.querySelector('button[type="submit"]');
            const form = document.getElementById('bulkMarkAttendanceForm');

            statusInput.value = status;
            statusDisplay.textContent = status;
            modalTitle.textContent = 'Bulk Mark as ' + status;

            if (status === 'PRESENT') {
                submitButton.className = 'btn btn-success';
                submitButton.textContent = 'Mark Present';
            } else {
                submitButton.className = 'btn btn-warning';
                submitButton.textContent = 'Mark Absent';
            }

            // Populate hidden filter inputs into the modal form
            ['adviser','course','search','search_by', 'section'].forEach(name => {
                const old = form.querySelector('input[name="' + name + '"]');
                if (old) old.remove();
            });
            const currentParams = new URLSearchParams(window.location.search);
            ['adviser','course','search','search_by', 'section'].forEach(name => {
                const val = currentParams.get(name);
                if (val) {
                    const inp = document.createElement('input');
                    inp.type = 'hidden';
                    inp.name = name;
                    inp.value = val;
                    form.appendChild(inp);
                }
            });
        });
    }

    // Select all subjects checkbox handling
    const selectAllCheckbox = document.getElementById('select_all_subjects');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            document.querySelectorAll('#absent-subjects-list .subject-checkbox').forEach(cb => cb.checked = selectAllCheckbox.checked);
        });
    }

    // Handle modal form submission: ensure at least one subject selected
    const makeAbsentForm = document.getElementById('makeAbsentForm');
    if (makeAbsentForm) {
        makeAbsentForm.addEventListener('submit', function(e) {
            const checked = Array.from(this.querySelectorAll('input[name="subject_ids"]:checked'));
            if (checked.length === 0) {
                e.preventDefault();
                alert('Please select at least one subject to mark absent.');
                return false;
            }
            // let the form submit normally (POST to server)
        });

        // Clear modal state when hidden (remove subject list and any injected hidden filter inputs)
        const modalEl = document.getElementById('makeAbsentModal');
        modalEl.addEventListener('hidden.bs.modal', function() {
            const listContainer = document.getElementById('absent-subjects-list');
            listContainer.innerHTML = '';
            const selectAll = document.getElementById('select_all_subjects');
            if (selectAll) selectAll.checked = false;

            // Remove injected hidden inputs from the form
            const makeAbsentFormEl = document.getElementById('makeAbsentForm');
            if (makeAbsentFormEl) {
                ['adviser','course','search','search_by'].forEach(name => {
                    const old = makeAbsentFormEl.querySelector('input[name="' + name + '"]');
                    if (old) old.remove();
                });
            }
        });
    }
    
    // Handle add student modal form submission
    const addStudentForm = document.getElementById('addStudentForm');
    if (addStudentForm) {
        addStudentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get submit button and disable it to prevent double submission
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton ? submitButton.innerHTML : '';
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
            }
            
            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                // Check content type to determine if it's JSON or HTML
                const contentType = response.headers.get('content-type');
                
                // Handle JSON responses (from AJAX-aware view)
                if (contentType && contentType.includes('application/json')) {
                    return response.json().then(data => {
                        if (data.success) {
                            // Success - close modal and redirect/reload
                            const modal = bootstrap.Modal.getInstance(document.getElementById('addStudentModal'));
                            if (modal) {
                                modal.hide();
                            }
                            // Redirect to the URL provided or reload
                            if (data.redirect_url) {
                                setTimeout(() => {
                                    window.location.href = data.redirect_url;
                                }, 300);
                            } else {
                                setTimeout(() => {
                                    window.location.reload();
                                }, 300);
                            }
                        } else {
                            // Show error message
                            alert('Error: ' + (data.error || 'An error occurred while adding the student.'));
                            // Re-enable submit button
                            if (submitButton) {
                                submitButton.disabled = false;
                                submitButton.innerHTML = originalButtonText;
                            }
                        }
                    });
                }
                
                // Handle redirects (non-AJAX responses)
                if (response.redirected) {
                    // Close modal before redirecting
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addStudentModal'));
                    if (modal) {
                        modal.hide();
                    }
                    window.location.href = response.url;
                    return;
                }
                
                // Check if response is ok
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Fallback to HTML parsing for non-JSON responses
                return response.text();
            })
            .then(html => {
                if (html && typeof html === 'string') {
                    // If there are errors, show them
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const errorMessages = doc.querySelectorAll('.alert-danger, .errorlist');
                    if (errorMessages.length > 0) {
                        const errorText = Array.from(errorMessages).map(el => el.textContent.trim()).filter(text => text).join('\n');
                        alert('Error: ' + errorText);
                        // Re-enable submit button
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.innerHTML = originalButtonText;
                        }
                    } else {
                        // Success - close modal and reload page
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addStudentModal'));
                        if (modal) {
                            modal.hide();
                        }
                        // Small delay to allow modal to close smoothly
                        setTimeout(() => {
                            window.location.reload();
                        }, 300);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while adding the student: ' + error.message);
                // Re-enable submit button on error
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                }
            });
        });
    }
    
    // Load dropdown data when modal opens and reset form when closed
    const addStudentModal = document.getElementById('addStudentModal');
    if (addStudentModal) {
        // Reset form when modal is hidden
        addStudentModal.addEventListener('hidden.bs.modal', function() {
            const form = document.getElementById('addStudentForm');
            if (form) {
                form.reset();
            }
        });
        
        // Load dropdowns when modal is shown
        addStudentModal.addEventListener('show.bs.modal', function() {
            // Store original server-side options as fallback
            const courseSelect = document.getElementById('modal_course');
            const sectionSelect = document.getElementById('modal_section');
            const adviserSelect = document.getElementById('modal_adviser');
            
            const originalCourseOptions = courseSelect ? courseSelect.innerHTML : '';
            const originalSectionOptions = sectionSelect ? sectionSelect.innerHTML : '';
            const originalAdviserOptions = adviserSelect ? adviserSelect.innerHTML : '';
            
            // Load courses
            if (courseSelect) {
                // Only show loading if there are no existing options
                if (courseSelect.options.length <= 1) {
                    courseSelect.disabled = true;
                    courseSelect.innerHTML = '<option value="">Loading courses...</option>';
                }
                fetch('{% url "api_courses" %}', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    credentials: 'same-origin'
                })
                    .then(response => {
                        if (!response.ok) {
                            // Try to parse error response
                            return response.json().then(errorData => {
                                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                            }).catch(() => {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Courses API response:', data);
                        if (data.success && data.courses && data.courses.length > 0) {
                            courseSelect.innerHTML = '<option value="">-- Select Course --</option>';
                            data.courses.forEach(course => {
                                const option = document.createElement('option');
                                option.value = course.id;
                                option.textContent = course.display || `${course.code} - ${course.name}`;
                                courseSelect.appendChild(option);
                            });
                            courseSelect.disabled = false;
                            // Auto-select if only one course
                            if (data.courses.length === 1) {
                                courseSelect.selectedIndex = 1;
                            }
                        } else {
                            // If API returns no data, keep original server-side options
                            if (originalCourseOptions && courseSelect.options.length <= 1) {
                                courseSelect.innerHTML = originalCourseOptions;
                            } else {
                                courseSelect.innerHTML = '<option value="">No courses available</option>';
                            }
                            courseSelect.disabled = false;
                            console.warn('No courses returned from API');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading courses:', error);
                        // On error, restore original server-side options if available
                        if (originalCourseOptions && courseSelect.options.length <= 1) {
                            courseSelect.innerHTML = originalCourseOptions;
                        } else {
                            courseSelect.innerHTML = `<option value="">Error: ${error.message}</option>`;
                        }
                        courseSelect.disabled = false;
                    });
            }
            
            // Load sections
            if (sectionSelect) {
                // Only show loading if there are no existing options
                if (sectionSelect.options.length <= 1) {
                    sectionSelect.disabled = true;
                    sectionSelect.innerHTML = '<option value="">Loading sections...</option>';
                }
                fetch('{% url "api_sections" %}', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    credentials: 'same-origin'
                })
                    .then(response => {
                        if (!response.ok) {
                            // Try to parse error response
                            return response.json().then(errorData => {
                                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                            }).catch(() => {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Sections API response:', data);
                        if (data.success && data.sections && data.sections.length > 0) {
                            sectionSelect.innerHTML = '<option value="">-- Select Section --</option>';
                            data.sections.forEach(section => {
                                const option = document.createElement('option');
                                option.value = section.id;
                                option.textContent = section.display || `${section.name} (${section.code})`;
                                sectionSelect.appendChild(option);
                            });
                            sectionSelect.disabled = false;
                        } else {
                            // If API returns no data, keep original server-side options
                            if (originalSectionOptions && sectionSelect.options.length <= 1) {
                                sectionSelect.innerHTML = originalSectionOptions;
                            } else {
                                sectionSelect.innerHTML = '<option value="">No sections available</option>';
                            }
                            sectionSelect.disabled = false;
                            console.warn('No sections returned from API');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading sections:', error);
                        // On error, restore original server-side options if available
                        if (originalSectionOptions && sectionSelect.options.length <= 1) {
                            sectionSelect.innerHTML = originalSectionOptions;
                        } else {
                            sectionSelect.innerHTML = `<option value="">Error: ${error.message}</option>`;
                        }
                        sectionSelect.disabled = false;
                    });
            }
            
            // Load advisers
            if (adviserSelect) {
                // Only show loading if there are no existing options
                if (adviserSelect.options.length <= 1) {
                    adviserSelect.disabled = true;
                    adviserSelect.innerHTML = '<option value="">Loading advisers...</option>';
                }
                fetch('{% url "api_advisers" %}', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    credentials: 'same-origin'
                })
                    .then(response => {
                        if (!response.ok) {
                            // Try to parse error response
                            return response.json().then(errorData => {
                                throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                            }).catch(() => {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Advisers API response:', data);
                        if (data.success && data.advisers && data.advisers.length > 0) {
                            adviserSelect.innerHTML = '<option value="">-- No Adviser --</option>';
                            data.advisers.forEach(adviser => {
                                const option = document.createElement('option');
                                option.value = adviser.id;
                                option.textContent = adviser.display || `${adviser.name} (${adviser.email})`;
                                adviserSelect.appendChild(option);
                            });
                            adviserSelect.disabled = false;
                            
                            // Auto-select current adviser if viewing their own filter
                            {% if current_adviser_id %}
                            const currentAdviserId = {{ current_adviser_id }};
                            const urlParams = new URLSearchParams(window.location.search);
                            const adviserFilter = urlParams.get('adviser');
                            
                            // If filtering by current adviser (by ID or name), auto-select them
                            if (adviserFilter) {
                                try {
                                    const filterAdviserId = parseInt(adviserFilter);
                                    if (filterAdviserId === currentAdviserId) {
                                        adviserSelect.value = currentAdviserId;
                                    }
                                } catch (e) {
                                    // If adviser filter is a name, check if it matches current adviser
                                    {% if adviser_name %}
                                    if (adviserFilter.toLowerCase() === '{{ adviser_name|lower }}') {
                                        adviserSelect.value = currentAdviserId;
                                    }
                                    {% endif %}
                                }
                            } else if (currentAdviserId) {
                                // If no filter but user is an adviser, auto-select themselves
                                adviserSelect.value = currentAdviserId;
                            }
                            {% endif %}
                        } else {
                            // If API returns no data, keep original server-side options
                            if (originalAdviserOptions && adviserSelect.options.length <= 1) {
                                adviserSelect.innerHTML = originalAdviserOptions;
                            } else {
                                adviserSelect.innerHTML = '<option value="">No advisers available</option>';
                            }
                            adviserSelect.disabled = false;
                            console.warn('No advisers returned from API');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading advisers:', error);
                        // On error, restore original server-side options if available
                        if (originalAdviserOptions && adviserSelect.options.length <= 1) {
                            adviserSelect.innerHTML = originalAdviserOptions;
                        } else {
                            adviserSelect.innerHTML = `<option value="">Error: ${error.message}</option>`;
                        }
                        adviserSelect.disabled = false;
                    });
            }
        });
    }

    // Handle student subjects modal
    const studentSubjectsModal = document.getElementById('studentSubjectsModal');
    if (studentSubjectsModal) {
        let allSubjects = []; // Store all subjects for filtering
        
        studentSubjectsModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const studentId = button.getAttribute('data-student-id');
            const studentName = button.getAttribute('data-student-name');
            
            // Update modal title with student name
            document.getElementById('student-name-display').textContent = studentName;
            
            // Show loading state
            document.getElementById('subjects-loading').classList.remove('d-none');
            document.getElementById('subjects-list').classList.add('d-none');
            document.getElementById('subjects-error').classList.add('d-none');
            document.getElementById('subjects-empty').classList.add('d-none');
            document.getElementById('semester-filter-container').classList.add('d-none');
            
            // Fetch student subjects
            fetch(`/api/student-subjects/${studentId}/`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }).catch(() => {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Hide loading
                document.getElementById('subjects-loading').classList.add('d-none');
                
                if (data.success && data.subjects && data.subjects.length > 0) {
                    allSubjects = data.subjects;
                    
                    // Populate semester filter
                    if (data.semesters && data.semesters.length > 1) {
                        const semesterFilter = document.getElementById('semester-filter');
                        semesterFilter.innerHTML = '<option value="">All Semesters</option>';
                        data.semesters.forEach(sem => {
                            const option = document.createElement('option');
                            option.value = sem;
                            option.textContent = sem;
                            semesterFilter.appendChild(option);
                        });
                        document.getElementById('semester-filter-container').classList.remove('d-none');
                    }
                    
                    // Display all subjects initially
                    displaySubjects(allSubjects);
                    document.getElementById('subjects-list').classList.remove('d-none');
                } else {
                    // No subjects found
                    document.getElementById('subjects-empty').classList.remove('d-none');
                }
            })
            .catch(error => {
                console.error('Error loading student subjects:', error);
                document.getElementById('subjects-loading').classList.add('d-none');
                document.getElementById('subjects-error').classList.remove('d-none');
                document.getElementById('error-message').textContent = error.message || 'Failed to load subjects.';
            });
        });
        
        // Function to display subjects
        function displaySubjects(subjects) {
            const tbody = document.getElementById('subjects-tbody');
            tbody.innerHTML = '';
            
            subjects.forEach(subject => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${subject.code}</strong></td>
                    <td>${subject.name}</td>
                    <td><span class="badge bg-info">${subject.semester || 'N/A'}</span></td>
                    <td><small class="text-muted">${subject.academic_year || 'N/A'}</small></td>
                    <td>
                        ${subject.has_schedule_today 
                            ? '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Yes</span>' 
                            : '<span class="badge bg-secondary"><i class="bi bi-x-circle"></i> No</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Handle semester filter change
        const semesterFilter = document.getElementById('semester-filter');
        if (semesterFilter) {
            semesterFilter.addEventListener('change', function() {
                const selectedSemester = this.value;
                
                if (selectedSemester === '') {
                    // Show all subjects
                    displaySubjects(allSubjects);
                } else {
                    // Filter by selected semester
                    const filtered = allSubjects.filter(s => s.semester === selectedSemester);
                    displaySubjects(filtered);
                }
            });
        }
    }
});
</script>
{% endblock %}
