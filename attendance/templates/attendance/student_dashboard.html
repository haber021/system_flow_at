{% extends 'attendance/base.html' %}

{% block title %}My Attendance - Student Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* Page Header Styling */
    .page-header {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .page-header h2 {
        color: white;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .page-header .student-info {
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.95rem;
        margin-bottom: 0;
    }
    
    .page-header .student-info i {
        margin-right: 0.5rem;
        opacity: 0.8;
    }
    
    .header-action-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        font-weight: 500;
        padding: 0.625rem 1.5rem;
        border-radius: 8px;
    }
    
    .header-action-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
    }
    
    .header-action-btn.active {
        background: rgba(255, 255, 255, 0.4);
        border-color: rgba(255, 255, 255, 0.6);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7);
        }
        50% {
            box-shadow: 0 0 0 10px rgba(255, 255, 255, 0);
        }
    }
    
    .auto-reload-controls {
        text-align: center;
    }
    
    /* Statistics Cards */
    .stat-card {
        border: none;
        border-radius: 12px;
        transition: all 0.3s ease;
        min-height: 140px;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .stat-card.present {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }
    
    .stat-card.absent {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }
    
    .stat-card.late {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }
    
    .stat-card.rate {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
    }
    
    .stat-card .card-body {
        padding: 1.5rem;
    }
    
    .stat-card .card-title {
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.95;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .stat-card .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        margin: 0;
    }
    
    .stat-card.rate .stat-value {
        font-size: 2rem;
    }
    
    /* Filter Card */
    .filter-card {
        border: none;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        border-radius: 12px;
        margin-bottom: 2rem;
        background: white;
    }
    
    .filter-card .card-header {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-bottom: 2px solid #e2e8f0;
        border-radius: 12px 12px 0 0 !important;
        padding: 1.25rem 1.5rem;
    }
    
    .filter-card .card-header h5 {
        color: #1e293b;
        font-weight: 600;
        margin: 0;
    }
    
    .filter-card .card-body {
        padding: 1.5rem;
    }
    
    /* Content Cards */
    .content-card {
        border: none;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        border-radius: 12px;
        margin-bottom: 2rem;
        background: white;
        overflow: hidden;
    }
    
    .content-card .card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 2px solid #e2e8f0;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
    
    .content-card .card-header.primary {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border-bottom: none;
    }
    
    .content-card .card-header.danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border-bottom: none;
    }
    
    .content-card .card-header h5 {
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .content-card .card-body {
        padding: 1.5rem;
    }
    
    /* Table Styling */
    .table {
        margin-bottom: 0;
    }
    
    .table thead th {
        background-color: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
        font-weight: 600;
        color: #1e293b;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        padding: 1rem;
    }
    
    .table tbody td {
        padding: 1rem;
        vertical-align: middle;
        color: #475569;
    }
    
    .table tbody tr {
        transition: background-color 0.2s ease;
    }
    
    .table tbody tr:hover {
        background-color: #f8fafc;
    }
    
    .absence-item {
        border-left: 4px solid #ef4444;
    }
    
    .absence-item td {
        background-color: #fef2f2;
    }
    
    .absence-item:hover td {
        background-color: #fee2e2;
    }
    
    /* Badge Styling */
    .badge {
        padding: 0.5rem 0.75rem;
        font-weight: 500;
        border-radius: 6px;
        font-size: 0.75rem;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
    }
    
    /* Progress Bar */
    .progress {
        height: 24px;
        border-radius: 6px;
        background-color: #e2e8f0;
        overflow: hidden;
    }
    
    .progress-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.75rem;
        color: white;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: #64748b;
    }
    
    .empty-state i {
        font-size: 3rem;
        color: #cbd5e1;
        margin-bottom: 1rem;
        display: block;
    }
    
    .empty-state h6 {
        color: #475569;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .empty-state p {
        margin-bottom: 0;
        color: #64748b;
    }
    
    /* Pagination */
    .pagination {
        margin-top: 1.5rem;
    }
    
    .page-link {
        border-radius: 6px;
        margin: 0 2px;
        border: 1px solid #e2e8f0;
        color: #475569;
        padding: 0.5rem 0.75rem;
        transition: all 0.2s ease;
    }
    
    .page-link:hover {
        background-color: #f1f5f9;
        border-color: #cbd5e1;
        color: #1e293b;
    }
    
    .page-item.active .page-link {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border-color: #2563eb;
    }
    
    /* Form Controls */
    .form-control:focus,
    .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.15);
    }
    
    /* Date Display */
    .date-display {
        display: flex;
        flex-direction: column;
    }
    
    .date-display strong {
        color: #1e293b;
        font-weight: 600;
    }
    
    .date-display small {
        color: #64748b;
        font-size: 0.75rem;
    }
    
    /* Button Styling */
    .btn {
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    /* Attendance Tabs Styling */
    .attendance-tabs {
        border-bottom: 2px solid #e2e8f0;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .attendance-tabs .nav-link {
        border: none;
        border-radius: 8px 8px 0 0;
        padding: 0.75rem 1.25rem;
        font-weight: 500;
        color: #64748b;
        background: #f1f5f9;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .attendance-tabs .nav-link:hover {
        color: #1e293b;
        background: #e2e8f0;
    }
    
    .attendance-tabs .nav-link.active {
        color: white;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border-bottom: 2px solid #2563eb;
        margin-bottom: -2px;
    }
    
    .attendance-tabs .nav-link .badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }
    
    .attendance-tabs .nav-link.active .badge {
        background: rgba(255, 255, 255, 0.3) !important;
        color: white !important;
    }
    
    .tab-date-header {
        display: flex;
        align-items: center;
    }
    
    .tab-date-header .badge {
        font-size: 0.85rem;
        padding: 0.5rem 1rem;
        font-weight: 500;
    }
    
    .tab-content > .tab-pane {
        padding-top: 0.5rem;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .page-header {
            padding: 1.5rem;
        }
        
        .page-header .d-flex {
            flex-direction: column;
            align-items: flex-start !important;
        }
        
        .header-action-btn {
            margin-top: 1rem;
            width: 100%;
        }
        
        .stat-card .stat-value {
            font-size: 2rem;
        }
        
        .table {
            font-size: 0.875rem;
        }
        
        .table thead th,
        .table tbody td {
            padding: 0.75rem 0.5rem;
        }
        
        .attendance-tabs {
            gap: 0.25rem;
        }
        
        .attendance-tabs .nav-link {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }
        
        .attendance-tabs .nav-link i {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap">
        <div>
            <h2>
                <i class="bi bi-person-circle me-2"></i>Welcome, {{ student.name|upper }}!
            </h2>
            <div class="student-info">
                <div class="mb-1">
                    <i class="bi bi-person-badge"></i>
                    <span>Student ID: <strong>{{ student.student_id|default:student.rfid_id }}</strong></span>
                </div>
                <div class="mb-1">
                    <i class="bi bi-book"></i>
                    <span>Course: <strong>{{ student.course }}</strong></span>
                </div>
                <div>
                    <i class="bi bi-people"></i>
                    <span>Section: <strong>{% if student.section %}{{ student.section.name }}{% if student.section.code %} ({{ student.section.code }}){% endif %}{% else %}N/A{% endif %}</strong></span>
                </div>
            </div>
        </div>
        <div class="d-flex gap-2 mt-3 mt-md-0 align-items-center">
            <div class="auto-reload-controls">
                <button type="button" id="autoReloadToggle" class="btn btn-sm header-action-btn" onclick="toggleAutoReload()">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    <span id="autoReloadText">Enable Auto-Reload</span>
                </button>
                <div id="autoReloadTimer" class="text-white-50 small mt-1" style="display: none;">
                    Next reload in: <span id="countdown">30</span>s
                </div>
            </div>
        </div>
    </div>

    <script>
    // Inject calendar events into attendance rows by date
    (function(){
        async function getEvents() {
            try {
                const resp = await fetch('/events/list/');
                if (!resp.ok) return [];
                const data = await resp.json();
                if (data && data.success && Array.isArray(data.events)) return data.events;
            } catch (e) {}
            return [];
        }

        function renderBadges(events) {
            const map = {};
            events.forEach(ev => {
                if (!ev.date) return;
                map[ev.date] = map[ev.date] || [];
                map[ev.date].push(ev);
            });

            document.querySelectorAll('tr[data-att-date]').forEach(function(row){
                const d = row.getAttribute('data-att-date');
                const cell = row.querySelector('.attendance-events-cell');
                if (!cell) return;
                cell.innerHTML = '';
                const todays = map[d] || [];
                todays.forEach(ev => {
                    const span = document.createElement('span');
                    span.className = 'badge bg-secondary me-1';
                    span.title = ev.description || '';
                    span.textContent = ev.title || (ev.type || 'Event');
                    cell.appendChild(span);
                });
            });
        }

        document.addEventListener('DOMContentLoaded', async function(){
            const evs = await getEvents();
            renderBadges(evs);
        });
    })();
    </script>
        </div>
        <a href="{% url 'student_enroll_subjects' %}" class="header-action-btn">
            <i class="bi bi-book-plus me-2"></i>Enroll in Subjects
        </a>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row g-4 mb-4">
    <div class="col-md-6 col-lg-3">
        <div class="card stat-card present">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-check-circle-fill"></i>
                    <span>Present</span>
                </h5>
                <p class="stat-value">{{ total_present }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="card stat-card absent">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-x-circle-fill"></i>
                    <span>Absent</span>
                </h5>
                <p class="stat-value">{{ total_absent }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="card stat-card late">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-clock-fill"></i>
                    <span>Late</span>
                </h5>
                <p class="stat-value">{{ total_late }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="card stat-card rate">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-graph-up-arrow"></i>
                    <span>Attendance Rate</span>
                </h5>
                <p class="stat-value">{{ attendance_rate }}%</p>
            </div>
        </div>
    </div>
</div>

<!-- Calendar Section -->
<div class="card content-card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
        <h5 class="mb-0">
            <i class="bi bi-calendar3 me-2"></i>Academic Calendar - {{ month_name }} {{ current_year }}
        </h5>
        <div class="d-flex gap-2 mt-2 mt-md-0 align-items-center">
            <select id="yearSelector" class="form-select form-select-sm" style="width: auto;" onchange="changeCalendarYear(this.value)">
                {% for year_option in year_range %}
                <option value="{{ year_option }}" {% if year_option == current_year %}selected{% endif %}>{{ year_option }}</option>
                {% endfor %}
            </select>
            <a href="?month={{ prev_month }}&year={{ prev_year }}{% if selected_subject_id %}&subject_id={{ selected_subject_id }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if academic_year %}&academic_year={{ academic_year }}{% endif %}{% if semester %}&semester={{ semester }}{% endif %}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-chevron-left"></i> Previous
            </a>
            <a href="?month={{ next_month }}&year={{ next_year }}{% if selected_subject_id %}&subject_id={{ selected_subject_id }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if academic_year %}&academic_year={{ academic_year }}{% endif %}{% if semester %}&semester={{ semester }}{% endif %}" class="btn btn-sm btn-outline-primary">
                Next <i class="bi bi-chevron-right"></i>
            </a>
        </div>
    </div>
    <div class="card-body">
        <div id="calendar-container" class="mb-3">
            <!-- Calendar will be rendered here by JavaScript -->
        </div>
        
        <!-- Legend -->
        <div class="calendar-legend d-flex flex-wrap gap-3 mt-3 pt-3 border-top">
            <div class="d-flex align-items-center gap-2">
                <span class="badge" style="background-color: #dc3545;">
                    <i class="bi bi-calendar-x me-1"></i>Holiday
                </span>
                <small class="text-muted">No Classes - Holiday</small>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span class="badge" style="background-color: #0d6efd;">
                    <i class="bi bi-calendar-event me-1"></i>Event
                </span>
                <small class="text-muted">School Event</small>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span class="badge" style="background-color: #6c757d;">
                    <i class="bi bi-info-circle me-1"></i>Other
                </span>
                <small class="text-muted">Other Event</small>
            </div>
        </div>
    </div>
</div>

<style>
.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-top: 1rem;
}

.calendar-day-header {
    text-align: center;
    padding: 0.75rem;
    font-weight: 600;
    background-color: #059669;
    color: white;
    border-radius: 6px;
    font-size: 0.875rem;
}

.calendar-day {
    min-height: 90px;
    padding: 0.5rem;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    background-color: white;
    position: relative;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
}

.calendar-day:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-color: #059669;
}

.calendar-day.other-month {
    background-color: #f8fafc;
    opacity: 0.5;
}

.calendar-day.today {
    background-color: #dbeafe;
    border-color: #3b82f6;
    border-width: 2px;
}

.calendar-day-number {
    font-weight: 600;
    color: #1e293b;
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}

.calendar-day.other-month .calendar-day-number {
    color: #94a3b8;
}

.calendar-event-badge {
    display: block;
    font-size: 0.65rem;
    padding: 0.2rem 0.4rem;
    margin-top: 0.25rem;
    border-radius: 4px;
    color: white;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
    cursor: pointer;
}

.calendar-event-badge.holiday {
    background-color: #dc3545;
}

.calendar-event-badge.event {
    background-color: #0d6efd;
}

.calendar-event-badge.other {
    background-color: #6c757d;
}

.calendar-legend {
    justify-content: center;
}

#calendar-container {
    overflow: visible;
}

@media (max-width: 992px) {
    .calendar-day {
        min-height: 70px;
        padding: 0.4rem;
    }
    
    .calendar-day-header {
        padding: 0.6rem 0.3rem;
        font-size: 0.8rem;
    }
    
    .calendar-event-badge {
        font-size: 0.62rem;
        padding: 0.18rem 0.35rem;
    }
}

@media (max-width: 768px) {
    .calendar-grid {
        gap: 2px;
    }
    
    .calendar-day {
        min-height: 65px;
        padding: 0.3rem;
    }
    
    .calendar-day-header {
        padding: 0.5rem 0.2rem;
        font-size: 0.7rem;
    }
    
    .calendar-day-number {
        font-size: 0.75rem;
    }
    
    .calendar-event-badge {
        font-size: 0.58rem;
        padding: 0.15rem 0.25rem;
        margin-top: 0.15rem;
    }
}

@media (max-width: 576px) {
    .calendar-grid {
        gap: 1px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .calendar-day {
        min-height: 55px;
        padding: 0.25rem;
    }
    
    .calendar-day-header {
        padding: 0.4rem 0.1rem;
        font-size: 0.65rem;
    }
    
    .calendar-day-number {
        font-size: 0.7rem;
        margin-bottom: 0.15rem;
    }
    
    .calendar-event-badge {
        font-size: 0.5rem;
        padding: 0.12rem 0.2rem;
        margin-top: 0.1rem;
    }
    
    .card-header h5 {
        font-size: 1rem;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
    
    .calendar-legend {
        flex-direction: column;
        gap: 0.75rem !important;
        align-items: flex-start !important;
    }
    
    .calendar-legend small {
        font-size: 0.75rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Calendar events data from Django context
    const calendarEvents = {{ calendar_events|safe }};
    const currentMonth = {{ current_month }};
    const currentYear = {{ current_year }};
    
    // Render calendar
    renderCalendar(currentYear, currentMonth, calendarEvents);
});

function renderCalendar(year, month, events) {
    const container = document.getElementById('calendar-container');
    
    // Create calendar grid
    const calendarGrid = document.createElement('div');
    calendarGrid.className = 'calendar-grid';
    
    // Day headers
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayNames.forEach(day => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.textContent = day;
        calendarGrid.appendChild(header);
    });
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();
    
    // Get previous month's last days
    const prevMonth = month === 1 ? 12 : month - 1;
    const prevYear = month === 1 ? year - 1 : year;
    const prevMonthLastDay = new Date(prevYear, prevMonth, 0).getDate();
    
    // Add previous month's trailing days
    for (let i = startingDayOfWeek - 1; i >= 0; i--) {
        const dayNum = prevMonthLastDay - i;
        const day = createCalendarDay(dayNum, true, null, []);
        calendarGrid.appendChild(day);
    }
    
    // Add current month's days
    const today = new Date();
    const isCurrentMonth = today.getMonth() === month - 1 && today.getFullYear() === year;
    
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayEvents = events.filter(e => e.date === dateStr);
        const isToday = isCurrentMonth && today.getDate() === day;
        
        const dayElement = createCalendarDay(day, false, isToday, dayEvents);
        calendarGrid.appendChild(dayElement);
    }
    
    // Add next month's leading days to complete the grid (always show 6 weeks)
    const totalCells = calendarGrid.children.length - 7; // Subtract day headers
    const remainingCells = 42 - totalCells; // 6 weeks * 7 days - current cells
    
    for (let day = 1; day <= remainingCells; day++) {
        const dayElement = createCalendarDay(day, true, false, []);
        calendarGrid.appendChild(dayElement);
    }
    
    container.innerHTML = '';
    container.appendChild(calendarGrid);
}

function createCalendarDay(dayNumber, isOtherMonth, isToday, events) {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'calendar-day';
    
    if (isOtherMonth) {
        dayDiv.classList.add('other-month');
    }
    
    if (isToday) {
        dayDiv.classList.add('today');
    }
    
    // Day number
    const dayNumDiv = document.createElement('div');
    dayNumDiv.className = 'calendar-day-number';
    dayNumDiv.textContent = dayNumber;
    dayDiv.appendChild(dayNumDiv);
    
    // Add events
    events.forEach(event => {
        const eventBadge = document.createElement('div');
        eventBadge.className = `calendar-event-badge ${event.event_type}`;
        eventBadge.textContent = event.title;
        eventBadge.title = `${event.title}${event.description ? ': ' + event.description : ''}${event.start_time ? ' (' + event.start_time + (event.end_time ? ' - ' + event.end_time : '') + ')' : ''}`;
        
        // Add click event to show details
        eventBadge.addEventListener('click', function() {
            showEventDetails(event);
        });
        
        dayDiv.appendChild(eventBadge);
    });
    
    return dayDiv;
}

function showEventDetails(event) {
    let timeInfo = '';
    if (event.start_time) {
        timeInfo = `<p class="mb-1"><strong>Time:</strong> ${event.start_time}${event.end_time ? ' - ' + event.end_time : ''}</p>`;
    }
    
    const modal = `
        <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="eventModalLabel">
                            <i class="bi bi-calendar-event me-2"></i>${event.title}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-1"><strong>Date:</strong> ${new Date(event.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        ${timeInfo}
                        <p class="mb-1"><strong>Type:</strong> <span class="badge bg-${event.event_type === 'holiday' ? 'danger' : event.event_type === 'event' ? 'primary' : 'secondary'}">${event.event_type.charAt(0).toUpperCase() + event.event_type.slice(1)}</span></p>
                        ${event.description ? `<p class="mb-0 mt-3"><strong>Description:</strong><br>${event.description}</p>` : ''}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('eventModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modal);
    
    // Show modal
    const modalElement = document.getElementById('eventModal');
    const bsModal = new bootstrap.Modal(modalElement);
    bsModal.show();
    
    // Remove modal from DOM after it's hidden
    modalElement.addEventListener('hidden.bs.modal', function() {
        modalElement.remove();
    });
}

function changeCalendarYear(selectedYear) {
    // Get current URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    
    // Update year parameter
    urlParams.set('year', selectedYear);
    
    // Keep the current month or default to January
    if (!urlParams.has('month')) {
        urlParams.set('month', '1');
    }
    
    // Redirect to updated URL
    window.location.href = '?' + urlParams.toString();
}

// Auto-reload functionality
let autoReloadInterval = null;
let countdownInterval = null;
let reloadSeconds = 30; // Reload every 30 seconds
let currentCountdown = reloadSeconds;

function toggleAutoReload() {
    const isEnabled = localStorage.getItem('autoReloadEnabled') === 'true';
    
    if (isEnabled) {
        disableAutoReload();
    } else {
        enableAutoReload();
    }
}

function enableAutoReload() {
    localStorage.setItem('autoReloadEnabled', 'true');
    
    // Update UI
    document.getElementById('autoReloadText').textContent = 'Disable Auto-Reload';
    document.getElementById('autoReloadToggle').classList.add('active');
    document.getElementById('autoReloadTimer').style.display = 'block';
    
    // Start countdown
    currentCountdown = reloadSeconds;
    updateCountdown();
    
    countdownInterval = setInterval(() => {
        currentCountdown--;
        updateCountdown();
        
        if (currentCountdown <= 0) {
            currentCountdown = reloadSeconds;
        }
    }, 1000);
    
    // Start auto-reload
    autoReloadInterval = setInterval(() => {
        location.reload();
    }, reloadSeconds * 1000);
    
    showNotification('Auto-reload enabled. Page will refresh every ' + reloadSeconds + ' seconds.', 'success');
}

function disableAutoReload() {
    localStorage.setItem('autoReloadEnabled', 'false');
    
    // Update UI
    document.getElementById('autoReloadText').textContent = 'Enable Auto-Reload';
    document.getElementById('autoReloadToggle').classList.remove('active');
    document.getElementById('autoReloadTimer').style.display = 'none';
    
    // Clear intervals
    if (autoReloadInterval) {
        clearInterval(autoReloadInterval);
        autoReloadInterval = null;
    }
    
    if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
    }
    
    showNotification('Auto-reload disabled.', 'info');
}

function updateCountdown() {
    document.getElementById('countdown').textContent = currentCountdown;
}

function showNotification(message, type = 'info') {
    // Create toast notification
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    // Add to toast container or create one
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
    toast.show();
    
    // Remove toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

// Initialize auto-reload on page load
document.addEventListener('DOMContentLoaded', function() {
    if (localStorage.getItem('autoReloadEnabled') === 'true') {
        enableAutoReload();
    }
});

</script>

<!-- Filters -->
<div class="card filter-card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="bi bi-funnel-fill me-2"></i>Filter Attendance Records
        </h5>
    </div>
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-4">
                <label for="subject_id" class="form-label fw-semibold">
                    <i class="bi bi-book me-1"></i>Subject
                </label>
                <select class="form-select" id="subject_id" name="subject_id">
                    <option value="">All Subjects</option>
                    {% for subject in subjects %}
                    <option value="{{ subject.id }}" {% if selected_subject_id_int == subject.id %}selected{% endif %}>
                        {{ subject.code }} - {{ subject.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="date_from" class="form-label fw-semibold">
                    <i class="bi bi-calendar-event me-1"></i>Date From
                </label>
                <input type="date" class="form-control" id="date_from" name="date_from" value="{{ date_from }}">
            </div>
            <div class="col-md-4">
                <div class="d-flex flex-column">
                    <label for="date_to" class="form-label fw-semibold">
                        <i class="bi bi-calendar-event-fill me-1"></i>Date To
                    </label>
                    <div class="d-flex gap-2">
                        <input type="date" class="form-control" id="date_to" name="date_to" value="{{ date_to }}">
                        <button type="submit" class="btn btn-primary btn-action">
                            <i class="bi bi-search"></i>
                            <span class="d-none d-md-inline">Filter</span>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Subject-wise Statistics -->
{% if subject_stats %}
<div class="card content-card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="bi bi-bar-chart-fill me-2"></i>Subject-wise Attendance Statistics
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Subject Code</th>
                        <th>Subject Name</th>
                        <th class="text-center">Total Days</th>
                        <th class="text-center">Present</th>
                        <th class="text-center">Absent</th>
                        <th class="text-center">Late</th>
                        <th>Attendance Rate</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in subject_stats %}
                    <tr>
                        <td><strong>{{ stat.subject.code }}</strong></td>
                        <td>{{ stat.subject.name }}</td>
                        <td class="text-center"><strong>{{ stat.total }}</strong></td>
                        <td class="text-center">
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle"></i>{{ stat.present }}
                            </span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-danger">
                                <i class="bi bi-x-circle"></i>{{ stat.absent }}
                            </span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-warning text-dark">
                                <i class="bi bi-clock"></i>{{ stat.late }}
                            </span>
                        </td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar {% if stat.rate >= 75 %}bg-success{% elif stat.rate >= 50 %}bg-warning{% else %}bg-danger{% endif %}" 
                                     role="progressbar" 
                                     style="width: {{ stat.rate }}%"
                                     aria-valuenow="{{ stat.rate }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    <strong>{{ stat.rate }}%</strong>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Attendance Records with Time In/Out -->
<div class="card content-card">
    <div class="card-header primary">
        <h5 class="mb-0">
            <i class="bi bi-clock-history me-2"></i>My Attendance Records
            <small class="opacity-75 ms-2">(Time In / Time Out)</small>
        </h5>
    </div>
    <div class="card-body">
        <!-- Time Period Tabs -->
        <ul class="nav nav-tabs attendance-tabs mb-4" id="attendanceTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="new-tab" data-bs-toggle="tab" data-bs-target="#new-records" type="button" role="tab" aria-controls="new-records" aria-selected="true">
                    <i class="bi bi-calendar-check me-1"></i>New (Today)
                    {% if today_count > 0 %}<span class="badge bg-success ms-1">{{ today_count }}</span>{% endif %}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="yesterday-tab" data-bs-toggle="tab" data-bs-target="#yesterday-records" type="button" role="tab" aria-controls="yesterday-records" aria-selected="false">
                    <i class="bi bi-calendar-minus me-1"></i>Yesterday
                    {% if yesterday_count > 0 %}<span class="badge bg-info ms-1">{{ yesterday_count }}</span>{% endif %}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pastweek-tab" data-bs-toggle="tab" data-bs-target="#pastweek-records" type="button" role="tab" aria-controls="pastweek-records" aria-selected="false">
                    <i class="bi bi-calendar-week me-1"></i>Past Week
                    {% if past_week_count > 0 %}<span class="badge bg-warning text-dark ms-1">{{ past_week_count }}</span>{% endif %}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="all-tab" data-bs-toggle="tab" data-bs-target="#all-records" type="button" role="tab" aria-controls="all-records" aria-selected="false">
                    <i class="bi bi-calendar3 me-1"></i>All Records
                </button>
            </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content" id="attendanceTabContent">
            <!-- New (Today) Tab -->
            <div class="tab-pane fade show active" id="new-records" role="tabpanel" aria-labelledby="new-tab">
                <div class="tab-date-header mb-3">
                    <span class="badge bg-primary"><i class="bi bi-calendar-event me-1"></i>{{ today_date|date:"l, F d, Y" }}</span>
                </div>
                {% if today_attendances %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Subject Code</th>
                                <th>Subject Name</th>
                                <th class="text-center">Events</th>
                                <th class="text-center">Time In</th>
                                <th class="text-center">Time Out</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in today_attendances %}
                            {% with attendance=item.attendance %}
                            <tr data-att-date="{{ attendance.date|date:'Y-m-d' }}">
                                <td>
                                    <div class="date-display">
                                        <strong>{{ attendance.date|date:"M d, Y" }}</strong>
                                        <small>{{ attendance.date|date:"l" }}</small>
                                    </div>
                                </td>
                                <td><strong>{{ attendance.subject.code }}</strong></td>
                                <td>{{ attendance.subject.name }}</td>
                                <td class="text-center attendance-events-cell">
                                    <!-- events will be injected here -->
                                </td>
                                <td class="text-center">
                                    {% if item.time_in_formatted %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-arrow-right-circle"></i>{{ item.time_in_formatted }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if item.time_out_formatted %}
                                        <span class="badge bg-info">
                                            <i class="bi bi-arrow-left-circle"></i>{{ item.time_out_formatted }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if attendance.status == 'PRESENT' %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i>{{ attendance.status }}
                                        </span>
                                    {% elif attendance.status == 'LATE' %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-clock"></i>{{ attendance.status }}
                                        </span>
                                    {% elif attendance.status == 'ABSENT' %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-x-circle"></i>{{ attendance.status }}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ attendance.status }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-calendar-x"></i>
                    <h6>No Records Today</h6>
                    <p>You don't have any attendance records for today yet.</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Yesterday Tab -->
            <div class="tab-pane fade" id="yesterday-records" role="tabpanel" aria-labelledby="yesterday-tab">
                <div class="tab-date-header mb-3">
                    <span class="badge bg-info"><i class="bi bi-calendar-event me-1"></i>{{ yesterday_date|date:"l, F d, Y" }}</span>
                </div>
                {% if yesterday_attendances %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Subject Code</th>
                                <th>Subject Name</th>
                                <th class="text-center">Events</th>
                                <th class="text-center">Time In</th>
                                <th class="text-center">Time Out</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in yesterday_attendances %}
                            {% with attendance=item.attendance %}
                            <tr data-att-date="{{ attendance.date|date:'Y-m-d' }}">
                                <td>
                                    <div class="date-display">
                                        <strong>{{ attendance.date|date:"M d, Y" }}</strong>
                                        <small>{{ attendance.date|date:"l" }}</small>
                                    </div>
                                </td>
                                <td><strong>{{ attendance.subject.code }}</strong></td>
                                <td>{{ attendance.subject.name }}</td>
                                <td class="text-center attendance-events-cell">
                                    <!-- events will be injected here -->
                                </td>
                                <td class="text-center">
                                    {% if item.time_in_formatted %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-arrow-right-circle"></i>{{ item.time_in_formatted }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if item.time_out_formatted %}
                                        <span class="badge bg-info">
                                            <i class="bi bi-arrow-left-circle"></i>{{ item.time_out_formatted }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if attendance.status == 'PRESENT' %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i>{{ attendance.status }}
                                        </span>
                                    {% elif attendance.status == 'LATE' %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-clock"></i>{{ attendance.status }}
                                        </span>
                                    {% elif attendance.status == 'ABSENT' %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-x-circle"></i>{{ attendance.status }}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ attendance.status }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-calendar-x"></i>
                    <h6>No Records Yesterday</h6>
                    <p>You don't have any attendance records from yesterday.</p>
                </div>
                {% endif %}
            </div>
            
            <!-- Past Week Tab -->
            <div class="tab-pane fade" id="pastweek-records" role="tabpanel" aria-labelledby="pastweek-tab">
                <div class="tab-date-header mb-3">
                    <span class="badge bg-warning text-dark"><i class="bi bi-calendar-range me-1"></i>{{ past_week_start|date:"M d" }} - {{ yesterday_date|date:"M d, Y" }}</span>
                </div>
                {% if past_week_attendances %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Subject Code</th>
                                <th>Subject Name</th>
                                <th class="text-center">Events</th>
                                <th class="text-center">Time In</th>
                                <th class="text-center">Time Out</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in past_week_attendances %}
                            {% with attendance=item.attendance %}
                            <tr data-att-date="{{ attendance.date|date:'Y-m-d' }}">
                                <td>
                                    <div class="date-display">
                                        <strong>{{ attendance.date|date:"M d, Y" }}</strong>
                                        <small>{{ attendance.date|date:"l" }}</small>
                                    </div>
                                </td>
                                <td><strong>{{ attendance.subject.code }}</strong></td>
                                <td>{{ attendance.subject.name }}</td>
                                <td class="text-center attendance-events-cell">
                                    <!-- events will be injected here -->
                                </td>
                                <td class="text-center">
                                    {% if item.time_in_formatted %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-arrow-right-circle"></i>{{ item.time_in_formatted }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if item.time_out_formatted %}
                                        <span class="badge bg-info">
                                            <i class="bi bi-arrow-left-circle"></i>{{ item.time_out_formatted }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if attendance.status == 'PRESENT' %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i>{{ attendance.status }}
                                        </span>
                                    {% elif attendance.status == 'LATE' %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-clock"></i>{{ attendance.status }}
                                        </span>
                                    {% elif attendance.status == 'ABSENT' %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-x-circle"></i>{{ attendance.status }}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ attendance.status }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-calendar-x"></i>
                    <h6>No Records This Past Week</h6>
                    <p>You don't have any attendance records from the past 7 days.</p>
                </div>
                {% endif %}
            </div>
            
            <!-- All Records Tab -->
            <div class="tab-pane fade" id="all-records" role="tabpanel" aria-labelledby="all-tab">
                {% if recent_attendances %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Subject Code</th>
                                <th>Subject Name</th>
                                <th class="text-center">Events</th>
                                <th class="text-center">Time In</th>
                                <th class="text-center">Time Out</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in recent_attendances %}
                            {% with attendance=item.attendance %}
                            <tr data-att-date="{{ attendance.date|date:'Y-m-d' }}">
                                <td>
                                    <div class="date-display">
                                        <strong>{{ attendance.date|date:"M d, Y" }}</strong>
                                        <small>{{ attendance.date|date:"l" }}</small>
                                    </div>
                                </td>
                                <td><strong>{{ attendance.subject.code }}</strong></td>
                                <td>{{ attendance.subject.name }}</td>
                                <td class="text-center attendance-events-cell">
                                    <!-- events will be injected here -->
                                </td>
                                <td class="text-center">
                                    {% if item.time_in_formatted %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-arrow-right-circle"></i>{{ item.time_in_formatted }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if item.time_out_formatted %}
                                        <span class="badge bg-info">
                                            <i class="bi bi-arrow-left-circle"></i>{{ item.time_out_formatted }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if attendance.status == 'PRESENT' %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i>{{ attendance.status }}
                                        </span>
                                    {% elif attendance.status == 'LATE' %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-clock"></i>{{ attendance.status }}
                                        </span>
                                    {% elif attendance.status == 'ABSENT' %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-x-circle"></i>{{ attendance.status }}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ attendance.status }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="bi bi-info-circle"></i>
                    <h6>No Attendance Records Found</h6>
                    <p>{% if selected_subject_id or date_from or date_to %}No records match your selected filters.{% else %}You don't have any attendance records yet.{% endif %}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Absences List -->
<div class="card content-card">
    <div class="card-header danger">
        <h5 class="mb-0">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>My Absences
            <span class="badge bg-light text-dark ms-2">{{ total_absent }}</span>
        </h5>
    </div>
    <div class="card-body">
        {% if absences %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Subject Code</th>
                        <th>Subject Name</th>
                        <th>Instructor</th>
                    </tr>
                </thead>
                <tbody>
                    {% for absence in absences %}
                    <tr class="absence-item">
                        <td>
                            <div class="date-display">
                                <strong>{{ absence.date|date:"M d, Y" }}</strong>
                                <small>{{ absence.date|date:"l" }}</small>
                            </div>
                        </td>
                        <td><strong>{{ absence.subject.code }}</strong></td>
                        <td>{{ absence.subject.name }}</td>
                        <td>{% if absence.subject.instructor %}{{ absence.subject.instructor.name }}{% else %}<span class="text-muted">—</span>{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if absences.has_other_pages %}
        <nav aria-label="Absences pagination">
            <ul class="pagination justify-content-center">
                {% if absences.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{% if selected_subject_id %}&subject_id={{ selected_subject_id }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                        <i class="bi bi-chevron-double-left"></i> First
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ absences.previous_page_number }}{% if selected_subject_id %}&subject_id={{ selected_subject_id }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                        <i class="bi bi-chevron-left"></i> Previous
                    </a>
                </li>
                {% endif %}
                
                <li class="page-item active">
                    <span class="page-link">
                        Page {{ absences.number }} of {{ absences.paginator.num_pages }}
                    </span>
                </li>
                
                {% if absences.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ absences.next_page_number }}{% if selected_subject_id %}&subject_id={{ selected_subject_id }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                        Next <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ absences.paginator.num_pages }}{% if selected_subject_id %}&subject_id={{ selected_subject_id }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                        Last <i class="bi bi-chevron-double-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        {% else %}
        <div class="empty-state">
            <i class="bi bi-check-circle"></i>
            <h6>Excellent! No Absences</h6>
            <p>{% if selected_subject_id or date_from or date_to %}You have no absences for the selected filters. Keep up the great attendance!{% else %}You have perfect attendance. Keep up the great work!{% endif %}</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}