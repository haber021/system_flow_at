{% extends 'attendance/base.html' %}
{% load email_filters %}

{% block title %}Enrollment Requests - Adviser Dashboard{% endblock %}

{% block extra_css %}
<style>
    /* Refined request card */
    .request-card {
        transition: transform 0.16s ease, box-shadow 0.16s ease;
        border: 1px solid rgba(16,24,40,0.04);
        border-radius: 12px;
        background: #ffffff;
    }

    .request-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(16,24,40,0.08);
    }

    /* Student avatar */
    .student-avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid rgba(0,0,0,0.04);
        background: #f3f4f6;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #374151;
        font-size: 0.95rem;
    }

    .initials-badge {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #eef2ff, #e0f2fe);
        color: #0f172a;
        font-weight: 700;
        font-size: 0.95rem;
    }

    /* Compact meta pieces */
    .meta-small { font-size: 0.9rem; color: #6b7280; }
    .muted-small { font-size: 0.85rem; color: #9ca3af; }

    /* Status badge */
    .badge-pending { background: #f59e0b; color: #fff; border-radius: 8px; padding: 6px 10px; font-weight: 600; }

    /* Compact card layout */
    .req-card-row { gap: 12px; }
    .req-actions .btn { min-width: 110px; }

    /* Small improvements to filter card */
    .filters-card .form-label { font-weight: 600; color: #374151; }

    /* Bulk action bar */
    #bulk-approve-bar { border-radius: 10px; border: 1px solid rgba(16,24,40,0.04); background: #fff; padding: 12px; }

    /* Loading overlay styles */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(15, 23, 42, 0.92);
        backdrop-filter: blur(4px);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        transition: opacity 0.3s ease;
    }
    
    .loading-overlay.active {
        display: flex;
    }
    
    .loading-spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(255, 255, 255, 0.2);
        border-top: 5px solid #10b981;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .loading-message {
        font-size: 20px;
        font-weight: 600;
        color: white;
        text-align: center;
        margin-bottom: 8px;
    }
    
    .loading-submessage {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.8);
        text-align: center;
    }
    
    .loading-content {
        background: white;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        text-align: center;
        min-width: 320px;
    }

    .loading-content .loading-spinner {
        border: 5px solid #e2e8f0;
        border-top: 5px solid #10b981;
    }

    .loading-content .loading-message {
        color: #1e293b;
    }

    .loading-content .loading-submessage {
        color: #64748b;
    }

    /* Responsive tweaks */
    @media (max-width: 767px) {
        .student-avatar, .initials-badge { width: 44px; height: 44px; font-size: 0.85rem; }
        .req-actions .btn { min-width: 90px; }
        .loading-content { min-width: 280px; padding: 30px; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div class="loading-overlay" id="approvalLoadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-message">Processing Approvals...</div>
        <div class="loading-submessage">Please wait while we process your request</div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-start mb-3">
    <div>
        <h2 class="mb-1" style="font-weight:700;">
            <i class="bi bi-clipboard-check"></i> Enrollment Requests
        </h2>
        <p class="text-muted mb-0">Review and manage student enrollment requests — keep it simple and quick.</p>
    </div>
    <div class="text-end">
        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary me-2 d-none d-md-inline">
            <i class="bi bi-arrow-left"></i> Back
        </a>
        <a href="#" class="btn btn-outline-primary d-none d-md-inline" title="Help">
            <i class="bi bi-question-circle"></i>
        </a>
    </div>
</div>

<!-- Statistics -->
<div class="row mb-4 g-3">
    <div class="col-md-4">
        <div class="card card-stat h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <small class="text-muted">Pending</small>
                    <div class="h4 mb-0" style="font-weight:700;">{{ total_pending }}</div>
                </div>
                <div class="text-end">
                    <i class="bi bi-clock-fill" style="font-size:28px;color:#f59e0b;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card card-stat h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <small class="text-muted">Approved</small>
                    <div class="h4 mb-0" style="font-weight:700;">{{ approved_count }}</div>
                </div>
                <div class="text-end">
                    <i class="bi bi-check-circle-fill" style="font-size:28px;color:#10b981;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card card-stat h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <small class="text-muted">Rejected</small>
                    <div class="h4 mb-0" style="font-weight:700;">{{ rejected_count }}</div>
                </div>
                <div class="text-end">
                    <i class="bi bi-x-circle-fill" style="font-size:28px;color:#ef4444;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4 filters-card">
    <div class="card-body">
        {% if not is_staff %}
        <div class="alert alert-info mb-3">
            <i class="bi bi-info-circle"></i> Showing enrollment requests for subjects assigned to: <strong>{{ adviser_name }}</strong>
            {% if total_all_pending > total_pending %}
            <br><small>Total pending requests in system: {{ total_all_pending }} (showing {{ total_pending }} for your instructors)</small>
            {% endif %}
        </div>
        {% else %}
        <div class="alert alert-success mb-3">
            <i class="bi bi-shield-check"></i> <strong>Staff/Admin View:</strong> Showing all pending enrollment requests
        </div>
        {% endif %}

        <form method="GET" class="row g-3 align-items-end">
            <div class="col-sm-6 col-md-2">
                <label for="academic_year" class="form-label">Academic Year</label>
                <input type="text" class="form-control" id="academic_year" name="academic_year" value="{{ academic_year }}" placeholder="e.g., 2025-2026">
            </div>
            <div class="col-sm-6 col-md-2">
                <label for="semester" class="form-label">Semester</label>
                <select class="form-select" id="semester" name="semester">
                    <option value="">All Semesters</option>
                    <option value="1st Semester" {% if semester == '1st Semester' %}selected{% endif %}>1st Semester</option>
                    <option value="2nd Semester" {% if semester == '2nd Semester' %}selected{% endif %}>2nd Semester</option>
                    <option value="Summer" {% if semester == 'Summer' %}selected{% endif %}>Summer</option>
                </select>
            </div>
            {% if not request.user.adviser_profile or request.user.is_staff or request.user.is_superuser %}
            <div class="col-sm-6 col-md-3">
                <label for="instructor_filter" class="form-label">Instructor</label>
                <select class="form-select" id="instructor_filter" name="instructor_filter">
                    <option value="">All Instructors</option>
                    {% for instructor in all_instructors %}
                    <option value="{{ instructor.id }}" {% if instructor_filter == instructor.id|stringformat:"s" %}selected{% endif %}>{{ instructor.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <div class="col-sm-6 col-md-3">
                <label for="student_search" class="form-label">Search</label>
                <input type="text" class="form-control" id="student_search" name="student_search" value="{{ student_search }}" placeholder="Student name, ID, or subject...">
            </div>
            <div class="col-sm-12 col-md-2 d-grid">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> Filter
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Enrollment Requests -->
{% if enrollment_requests %}

<!-- Bulk Actions -->
<div class="mb-3" id="bulk-approve-bar">
    <form method="POST" id="bulk-approve-form">
        {% csrf_token %}
        <div class="d-flex align-items-center justify-content-between flex-wrap" style="gap:12px;">
            <div class="d-flex align-items-center" style="gap:12px;">
                <div class="form-check mb-0">
                    <input class="form-check-input" type="checkbox" id="select-all-checkbox">
                    <label class="form-check-label" for="select-all-checkbox"><strong>Select All</strong></label>
                </div>
                <div class="muted-small">Selected: <span id="selected-count">0</span> / {{ enrollment_requests|length }}</div>
            </div>

            <div class="d-flex align-items-center flex-wrap" style="gap:10px;">
                <textarea class="form-control form-control-sm" id="bulk_notes" name="bulk_notes" rows="1" placeholder="Optional note for all requests..." style="min-width:300px; max-width:400px;"></textarea>
                <button type="button" class="btn btn-success" id="approve-all-btn" title="Approve all {{ enrollment_requests|length }} visible requests">
                    <i class="bi bi-check-all"></i> Approve All ({{ enrollment_requests|length }})
                </button>
            </div>
        </div>
    </form>
</div>

<div class="row g-3">
    {% for req in enrollment_requests %}
    <div class="col-lg-6 col-md-6">
        <div class="card request-card">
            <div class="card-body d-flex req-card-row">
                <div class="d-flex flex-column align-items-center me-3" style="width:70px;">
                    {% if req.student.get_profile_picture_url %}
                        <img src="{{ req.student.get_profile_picture_url }}" alt="{{ req.student.name }}" class="student-avatar"> 
                    {% else %}
                        <div class="initials-badge">{{ req.student.name|slice:":1"|upper }}</div>
                    {% endif %}
                    <div class="mt-2 meta-small text-center">{{ req.student.student_id|default:"—" }}</div>
                </div>

                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <div>
                            <div style="font-weight:700;">{{ req.subject.code }} — {{ req.subject.name }}</div>
                            <div class="muted-small">{{ req.student.name|upper }} • {{ req.student.course }}</div>
                        </div>
                        <div class="text-end">
                            <div class="badge-pending"><i class="bi bi-clock"></i> Pending</div>
                            <div class="muted-small mt-1">Requested: {{ req.requested_at|date:"M d, Y g:i A" }}</div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-end mt-2">
                        <div class="muted-small">
                            Instructor: {% if req.subject.instructor %}{{ req.subject.instructor.name }}{% else %}—{% endif %}
                            {% if req.subject.schedules.all %}
                                • {% for schedule in req.subject.schedules.all %}{% if not forloop.first %}, {% endif %}{{ schedule.get_day_name }} ({{ schedule.time_start|time:"g:i A" }}){% endfor %}
                            {% endif %}
                        </div>
                        <div class="req-actions d-flex" style="gap:8px;">
                            <div class="form-check align-self-center mb-0">
                                <input class="form-check-input request-checkbox" type="checkbox" name="selected_requests" value="{{ req.id }}" id="checkbox_{{ req.id }}">
                            </div>
                            <form method="POST" class="d-inline-block">
                                {% csrf_token %}
                                <input type="hidden" name="request_id" value="{{ req.id }}">
                                <input type="hidden" name="notes" id="notes_{{ req.id }}_hidden">
                                <button type="button" class="btn btn-outline-danger btn-sm reject-btn" data-message="Reject enrollment for {{ req.student.name }} in {{ req.subject.code }}?">
                                    <i class="bi bi-x-circle"></i> Reject
                                </button>
                            </form>
                            <form method="POST" class="d-inline-block">
                                {% csrf_token %}
                                <input type="hidden" name="request_id" value="{{ req.id }}">
                                <button type="button" class="btn btn-success btn-sm approve-btn" data-message="Approve enrollment for {{ req.student.name }} in {{ req.subject.code }}?">
                                    <i class="bi bi-check-circle"></i> Approve
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent border-0 pt-0">
                <div class="row g-2 align-items-center">
                    <div class="col-12">
                        <textarea class="form-control form-control-sm" id="notes_{{ req.id }}" placeholder="Add notes for the student (optional)..." rows="2"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% else %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i> No pending enrollment requests found.
</div>
{% endif %}

<hr>
<div class="d-flex justify-content-between">
    <div>
        <a href="{% url 'dashboard' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
    <div class="text-muted-small">Showing {{ enrollment_requests|length }} request(s)</div>
</div>

<script>
// Keep existing behavior but make confirmations use common modal (already available in base)
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const requestCheckboxes = document.querySelectorAll('.request-checkbox');
    const selectedCountEl = document.getElementById('selected-count');
    const bulkApproveForm = document.getElementById('bulk-approve-form');
    const loadingOverlay = document.getElementById('approvalLoadingOverlay');
    let isSubmitting = false;

    function updateSelectedCount() {
        const selectedCount = document.querySelectorAll('.request-checkbox:checked').length;
        selectedCountEl.textContent = selectedCount;
        if (selectAllCheckbox && requestCheckboxes.length > 0) {
            const allChecked = document.querySelectorAll('.request-checkbox:checked').length === requestCheckboxes.length;
            const someChecked = document.querySelectorAll('.request-checkbox:checked').length > 0;
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = someChecked && !allChecked;
        }
    }

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            requestCheckboxes.forEach(function(checkbox) { checkbox.checked = selectAllCheckbox.checked; });
            updateSelectedCount();
        });
    }

    requestCheckboxes.forEach(function(checkbox) { checkbox.addEventListener('change', updateSelectedCount); });
    updateSelectedCount();

    // Handle "Approve All" button
    const approveAllBtn = document.getElementById('approve-all-btn');
    if (approveAllBtn) {
        approveAllBtn.addEventListener('click', function() {
            if (isSubmitting) return;
            
            const selectedCheckboxes = document.querySelectorAll('.request-checkbox:checked');
            const allRequestsCount = requestCheckboxes.length;
            
            // Determine if we're approving all or just selected
            const count = selectedCheckboxes.length > 0 ? selectedCheckboxes.length : allRequestsCount;
            
            if (count === 0) {
                alert('No enrollment requests to approve.');
                return;
            }

            const message = selectedCheckboxes.length > 0 
                ? `Are you sure you want to approve ${count} selected enrollment request(s)?`
                : `Are you sure you want to approve ALL ${count} visible enrollment request(s)?\n\nThis will approve every request shown on this page.`;
            
            customConfirm(message, function(confirmed) {
                if (!confirmed) return;
                
                isSubmitting = true;
                
                // Show loading overlay
                if (loadingOverlay) {
                    loadingOverlay.classList.add('active');
                    const loadingMessage = loadingOverlay.querySelector('.loading-message');
                    const loadingSubmessage = loadingOverlay.querySelector('.loading-submessage');
                    if (loadingMessage) loadingMessage.textContent = `Approving ${count} Request(s)...`;
                    if (loadingSubmessage) loadingSubmessage.textContent = 'Processing enrollments and sending notifications';
                }
                
                // Disable button
                approveAllBtn.disabled = true;
                approveAllBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
                
                // Remove any previously appended hidden inputs
                const existingHiddenInputs = bulkApproveForm.querySelectorAll('input[name="selected_requests"]');
                existingHiddenInputs.forEach(function(input) {
                    input.remove();
                });
                
                // Add request IDs to the form (selected ones or all if none selected)
                const checkboxesToProcess = selectedCheckboxes.length > 0 ? selectedCheckboxes : requestCheckboxes;
                checkboxesToProcess.forEach(function(checkbox) {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'selected_requests';
                    hiddenInput.value = checkbox.value;
                    bulkApproveForm.appendChild(hiddenInput);
                });
                
                // Add action and submit
                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'bulk_approve';
                bulkApproveForm.appendChild(actionInput);
                
                bulkApproveForm.submit();
            });
        });
    }

    // Approve/Reject buttons: find buttons and submit respective parent forms
    document.querySelectorAll('.approve-btn, .reject-btn').forEach(function(button) {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (isSubmitting) return;
            
            const message = button.getAttribute('data-message');
            customConfirm(message, function(confirmed) {
                if (!confirmed) return;
                
                isSubmitting = true;
                
                // Show loading overlay
                if (loadingOverlay) {
                    loadingOverlay.classList.add('active');
                    const loadingMessage = loadingOverlay.querySelector('.loading-message');
                    const loadingSubmessage = loadingOverlay.querySelector('.loading-submessage');
                    const isApprove = button.classList.contains('approve-btn');
                    if (loadingMessage) loadingMessage.textContent = isApprove ? 'Approving Request...' : 'Rejecting Request...';
                    if (loadingSubmessage) loadingSubmessage.textContent = 'Please wait';
                }
                
                // Disable button
                button.disabled = true;
                button.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
                
                // find nearest form (the one we created for actions)
                const form = button.closest('form');
                if (!form) return;

                // For approve, add hidden input action=approve; for reject, action=reject
                const actionVal = button.classList.contains('approve-btn') ? 'approve' : 'reject';
                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = actionVal;
                form.appendChild(actionInput);

                // If there is a notes textarea in the card, copy its value to a hidden notes field
                const notesField = document.getElementById('notes_' + form.querySelector('input[name="request_id"]').value);
                if (notesField) {
                    const hiddenNotes = form.querySelector('input[name="notes"]') || form.querySelector('#notes_' + form.querySelector('input[name="request_id"]').value + '_hidden');
                    if (hiddenNotes) {
                        hiddenNotes.value = notesField.value.trim();
                    }
                }

                form.submit();
            });
        });
    });
    
    // Handle page back/forward cache to reset loading state
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            isSubmitting = false;
            if (loadingOverlay) loadingOverlay.classList.remove('active');
            
            // Reset buttons
            if (approveAllBtn) {
                approveAllBtn.disabled = false;
                approveAllBtn.innerHTML = '<i class="bi bi-check-all"></i> Approve All ({{ enrollment_requests|length }})';
            }
            
            // Reset individual action buttons
            document.querySelectorAll('.approve-btn, .reject-btn').forEach(function(btn) {
                btn.disabled = false;
                if (btn.classList.contains('approve-btn')) {
                    btn.innerHTML = '<i class="bi bi-check-circle"></i> Approve';
                } else {
                    btn.innerHTML = '<i class="bi bi-x-circle"></i> Reject';
                }
            });
        }
    });
});
</script>

{% endblock %}
