{% extends 'attendance/base.html' %}
{% load email_filters %}

{% block title %}Email Logs{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-envelope"></i> Email Logs</h2>
</div>

<div class="card mb-3">
    <div class="card-body">
        <form method="GET" action="{% url 'email_logs' %}" class="row g-3">
            <div class="col-md-3">
                <label for="type" class="form-label">Filter:</label>
                <select class="form-select" id="type" name="type">
                    <option value="">All Reports</option>
                    <option value="SEMESTER" {% if email_type == 'SEMESTER' %}selected{% endif %}>Semester</option>
                    <option value="WARNING" {% if email_type == 'WARNING' %}selected{% endif %}>Warning</option>
                    <option value="DAILY" {% if email_type == 'DAILY' %}selected{% endif %}>Daily</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="date_from" class="form-label">Date From:</label>
                <input type="date" class="form-control" id="date_from" name="date_from" value="{{ date_from }}">
            </div>
            <div class="col-md-3">
                <label for="date_to" class="form-label">Date To:</label>
                <input type="date" class="form-control" id="date_to" name="date_to" value="{{ date_to }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-funnel"></i> Filter
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Date Sent</th>
                        <th>Student Name</th>
                        <th>Type</th>
                        <th>Email To</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>{{ log.sent_at|date:"m/d/y"|default:log.created_at|date:"m/d/y" }}</td>
                        <td>{{ log.student.name }}</td>
                        <td>{{ log.get_email_type_display }}</td>
                        <td>{{ log.email_to|mask_email }}</td>
                        <td>
                            {% if log.status == 'SENT' %}
                                <span class="badge bg-success">Sent ✓</span>
                            {% elif log.status == 'FAILED' %}
                                <span class="badge bg-danger">Failed ✗</span>
                            {% else %}
                                <span class="badge bg-warning">Pending</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if log.status == 'FAILED' %}
                            <form method="POST" action="{% url 'email_resend' log.id %}" class="d-inline resend-email-form" data-email-to="{{ log.email_to|mask_email }}" data-student-name="{{ log.student.name }}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-primary resend-email-btn">
                                    <i class="bi bi-arrow-repeat"></i> Resend
                                </button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">No email logs found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="mt-3 p-3 bg-light rounded">
            <strong>Total Sent:</strong> {{ stats.total_sent }} | 
            <strong>Failed:</strong> {{ stats.total_failed }}
        </div>
    </div>
</div>

<style>
/* Email Loading Modal Styles */
.email-loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

.email-loading-modal {
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    max-width: 500px;
    width: 90%;
    overflow: hidden;
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from {
        transform: translateY(30px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.email-loading-header {
    background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
    color: white;
    padding: 1.5rem;
    text-align: center;
}

.email-loading-header h4 {
    margin: 0;
    font-weight: 600;
}

.email-loading-body {
    padding: 2rem;
    text-align: center;
}

.loading-info {
    text-align: left;
}

.loading-details {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid #0d6efd;
}

.loading-details p {
    margin-bottom: 0.5rem;
}

.loading-details i {
    color: #0d6efd;
    margin-right: 0.5rem;
}
</style>

<script>
// Show loading modal for email resend
function showEmailResendLoadingModal(emailTo, studentName) {
    const modalHtml = `
        <div class="email-loading-overlay" id="emailLoadingOverlay">
            <div class="email-loading-modal">
                <div class="email-loading-header">
                    <h4><i class="bi bi-envelope-fill"></i> Resending Email</h4>
                </div>
                <div class="email-loading-body">
                    <div class="text-center mb-4">
                        <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div class="loading-info">
                        <p class="mb-2"><strong>Resending email to <span id="loadingEmail">${emailTo}</span></strong></p>
                        <p class="mb-1 text-muted"><small>Student: ${studentName}</small></p>
                        <p class="text-muted mb-3">Please wait while we resend the email.</p>
                        <div class="progress mb-2" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                 role="progressbar" 
                                 style="width: 100%" 
                                 aria-valuenow="100" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                Sending...
                            </div>
                        </div>
                        <div class="loading-details mt-3">
                            <p class="mb-0"><i class="bi bi-clock"></i> <small>Check the terminal/console for detailed sending progress</small></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existing = document.getElementById('emailLoadingOverlay');
    if (existing) {
        existing.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Prevent body scroll
    document.body.style.overflow = 'hidden';
}

// Add form submit handlers for resend buttons
document.addEventListener('DOMContentLoaded', function() {
    const resendForms = document.querySelectorAll('.resend-email-form');
    
    resendForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const emailTo = this.getAttribute('data-email-to');
            const studentName = this.getAttribute('data-student-name');
            const submitBtn = this.querySelector('.resend-email-btn');
            
            // Show loading modal
            showEmailResendLoadingModal(emailTo, studentName);
            
            // Disable submit button to prevent double submission
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
            }
        });
    });
});
</script>
{% endblock %}

