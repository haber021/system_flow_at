{% extends 'attendance/base.html' %}
{% load email_filters %}

{% block title %}Email Logs{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-envelope"></i> Email Logs</h2>
    <div>
        <a href="{% url 'email_logs_export_csv' %}?type={{ email_type }}&status={{ status }}&date_from={{ date_from }}&date_to={{ date_to }}" 
           class="btn btn-success">
            <i class="bi bi-download"></i> Export to CSV
        </a>
    </div>
</div>

<div class="card mb-3">
    <div class="card-body">
        <form method="GET" action="{% url 'email_logs' %}" class="row g-3">
            <div class="col-md-3">
                <label for="type" class="form-label">Email Type:</label>
                <select class="form-select" id="type" name="type">
                    <option value="">All Types</option>
                    <option value="SEMESTER" {% if email_type == 'SEMESTER' %}selected{% endif %}>Semester Report</option>
                    <option value="WARNING" {% if email_type == 'WARNING' %}selected{% endif %}>Warning</option>
                    <option value="DAILY" {% if email_type == 'DAILY' %}selected{% endif %}>Daily Report</option>
                    <option value="CUSTOM" {% if email_type == 'CUSTOM' %}selected{% endif %}>Custom</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">Status:</label>
                <select class="form-select" id="status" name="status">
                    <option value="">All Statuses</option>
                    <option value="SENT" {% if status == 'SENT' %}selected{% endif %}>Sent</option>
                    <option value="FAILED" {% if status == 'FAILED' %}selected{% endif %}>Failed</option>
                    <option value="PENDING" {% if status == 'PENDING' %}selected{% endif %}>Pending</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="date_from" class="form-label">Date From:</label>
                <input type="date" class="form-control" id="date_from" name="date_from" value="{{ date_from }}">
            </div>
            <div class="col-md-2">
                <label for="date_to" class="form-label">Date To:</label>
                <input type="date" class="form-control" id="date_to" name="date_to" value="{{ date_to }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary flex-fill">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                    <a href="{% url 'email_logs' %}" class="btn btn-outline-secondary" title="Clear filters">
                        <i class="bi bi-x-circle"></i>
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Date Sent</th>
                        <th>Student Name</th>
                        <th>Student ID</th>
                        <th>Type</th>
                        <th>Email To</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td>
                            {% if log.sent_at %}
                                {{ log.sent_at|date:"M d, Y g:i A" }}
                            {% else %}
                                {{ log.created_at|date:"M d, Y g:i A" }}
                            {% endif %}
                        </td>
                        <td>{{ log.student.name|upper }}</td>
                        <td>{{ log.student.student_id|default:"N/A" }}</td>
                        <td>
                            {% if log.email_type == 'SEMESTER' %}
                                <span class="badge bg-info">Semester Report</span>
                            {% elif log.email_type == 'WARNING' %}
                                <span class="badge bg-warning text-dark">Warning</span>
                            {% elif log.email_type == 'DAILY' %}
                                <span class="badge bg-primary">Daily Report</span>
                            {% elif log.email_type == 'CUSTOM' %}
                                <span class="badge bg-secondary">Custom</span>
                            {% else %}
                                {{ log.get_email_type_display }}
                            {% endif %}
                        </td>
                        <td>{{ log.email_to|mask_email }}</td>
                        <td>
                            {% if log.status == 'SENT' %}
                                <span class="badge bg-success">
                                    <i class="bi bi-check-circle"></i> Sent
                                </span>
                            {% elif log.status == 'FAILED' %}
                                <span class="badge bg-danger" title="{{ log.error_message }}">
                                    <i class="bi bi-x-circle"></i> Failed
                                </span>
                            {% else %}
                                <span class="badge bg-warning">
                                    <i class="bi bi-clock"></i> Pending
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if log.status == 'FAILED' %}
                            <form method="POST" action="{% url 'email_resend' log.id %}" class="d-inline resend-email-form" data-email-to="{{ log.email_to|mask_email }}" data-student-name="{{ log.student.name }}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-primary resend-email-btn" title="Resend email">
                                    <i class="bi bi-arrow-repeat"></i> Resend
                                </button>
                            </form>
                            {% elif log.status == 'SENT' %}
                                <span class="text-muted">
                                    <i class="bi bi-check"></i>
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2">No email logs found.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="mt-3 p-3 bg-light rounded">
            <div class="row text-center">
                <div class="col-md-4">
                    <strong>Total Sent:</strong> 
                    <span class="badge bg-success ms-1">{{ stats.total_sent }}</span>
                </div>
                <div class="col-md-4">
                    <strong>Failed:</strong> 
                    <span class="badge bg-danger ms-1">{{ stats.total_failed }}</span>
                </div>
                <div class="col-md-4">
                    <strong>Pending:</strong> 
                    <span class="badge bg-warning text-dark ms-1">{{ stats.total_pending }}</span>
                </div>
            </div>
        </div>
        
        <!-- Pagination -->
        {% if logs.has_other_pages %}
        <nav aria-label="Email logs pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if logs.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if email_type %}&type={{ email_type }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                            <i class="bi bi-chevron-double-left"></i> First
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ logs.previous_page_number }}{% if email_type %}&type={{ email_type }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                            <i class="bi bi-chevron-left"></i> Previous
                        </a>
                    </li>
                {% endif %}
                
                <li class="page-item active">
                    <span class="page-link">
                        Page {{ logs.number }} of {{ logs.paginator.num_pages }}
                    </span>
                </li>
                
                {% if logs.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ logs.next_page_number }}{% if email_type %}&type={{ email_type }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                            Next <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ logs.paginator.num_pages }}{% if email_type %}&type={{ email_type }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                            Last <i class="bi bi-chevron-double-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<style>
/* Email Loading Modal Styles */
.email-loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

.email-loading-modal {
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    max-width: 500px;
    width: 90%;
    overflow: hidden;
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from {
        transform: translateY(30px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.email-loading-header {
    background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
    color: white;
    padding: 1.5rem;
    text-align: center;
}

.email-loading-header h4 {
    margin: 0;
    font-weight: 600;
}

.email-loading-body {
    padding: 2rem;
    text-align: center;
}

.loading-info {
    text-align: left;
}

.loading-details {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid #0d6efd;
}

.loading-details p {
    margin-bottom: 0.5rem;
}

.loading-details i {
    color: #0d6efd;
    margin-right: 0.5rem;
}
</style>

<script>
// Show loading modal for email resend
function showEmailResendLoadingModal(emailTo, studentName) {
    const modalHtml = `
        <div class="email-loading-overlay" id="emailLoadingOverlay">
            <div class="email-loading-modal">
                <div class="email-loading-header">
                    <h4><i class="bi bi-envelope-fill"></i> Resending Email</h4>
                </div>
                <div class="email-loading-body">
                    <div class="text-center mb-4">
                        <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div class="loading-info">
                        <p class="mb-2"><strong>Resending email to <span id="loadingEmail">${emailTo}</span></strong></p>
                        <p class="mb-1 text-muted"><small>Student: ${studentName}</small></p>
                        <p class="text-muted mb-3">Please wait while we resend the email.</p>
                        <div class="progress mb-2" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                 role="progressbar" 
                                 style="width: 100%" 
                                 aria-valuenow="100" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                Sending...
                            </div>
                        </div>
                        <div class="loading-details mt-3">
                            <p class="mb-0"><i class="bi bi-clock"></i> <small>Check the terminal/console for detailed sending progress</small></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existing = document.getElementById('emailLoadingOverlay');
    if (existing) {
        existing.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Prevent body scroll
    document.body.style.overflow = 'hidden';
}

// Add form submit handlers for resend buttons
document.addEventListener('DOMContentLoaded', function() {
    const resendForms = document.querySelectorAll('.resend-email-form');
    
    resendForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const emailTo = this.getAttribute('data-email-to');
            const studentName = this.getAttribute('data-student-name');
            const submitBtn = this.querySelector('.resend-email-btn');
            
            // Show loading modal
            showEmailResendLoadingModal(emailTo, studentName);
            
            // Disable submit button to prevent double submission
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
            }
        });
    });
});
</script>
{% endblock %}

