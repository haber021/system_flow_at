{% extends 'attendance/base.html' %}

{% block title %}Email Report Preview{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0"><i class="bi bi-envelope"></i> Email Report Preview</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{% url 'email_preview' student.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="academic_year" value="{{ academic_year }}">
                    <input type="hidden" name="semester" value="{{ semester }}">
                    
                    <div class="mb-3">
                        <label for="email_to" class="form-label">To:</label>
                        <input type="email" class="form-control" id="email_to" name="email_to" value="{{ email_to }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="email_cc" class="form-label">CC:</label>
                        <input type="email" class="form-control" id="email_cc" name="email_cc" placeholder="Optional">
                    </div>
                    <div class="mb-3">
                        <label for="email_bcc" class="form-label">BCC:</label>
                        <input type="email" class="form-control" id="email_bcc" name="email_bcc" placeholder="Optional">
                    </div>
                    <div class="mb-3">
                        <label for="subject" class="form-label">Subject:</label>
                        <input type="text" class="form-control" id="subject" name="subject" value="{{ subject }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="message_body" class="form-label">Message Body:</label>
                        <textarea class="form-control" id="message_body" name="message_body" rows="15" required>{{ message_body }}</textarea>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" id="sendEmailBtn">
                            <i class="bi bi-send"></i> Send Email
                        </button>
                        <a href="{% url 'student_summary_detail' student.id %}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* Email Loading Modal Styles */
.email-loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

.email-loading-modal {
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    max-width: 500px;
    width: 90%;
    overflow: hidden;
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from {
        transform: translateY(30px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.email-loading-header {
    background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
    color: white;
    padding: 1.5rem;
    text-align: center;
}

.email-loading-header h4 {
    margin: 0;
    font-weight: 600;
}

.email-loading-body {
    padding: 2rem;
    text-align: center;
}

.loading-info {
    text-align: left;
}

.loading-details {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid #0d6efd;
}

.loading-details p {
    margin-bottom: 0.5rem;
}

.loading-details i {
    color: #0d6efd;
    margin-right: 0.5rem;
}
</style>

<script>
// Show loading modal for single email sending
function showEmailLoadingModal(emailTo) {
    const modalHtml = `
        <div class="email-loading-overlay" id="emailLoadingOverlay">
            <div class="email-loading-modal">
                <div class="email-loading-header">
                    <h4><i class="bi bi-envelope-fill"></i> Sending Email</h4>
                </div>
                <div class="email-loading-body">
                    <div class="text-center mb-4">
                        <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div class="loading-info">
                        <p class="mb-2"><strong>Sending email to <span id="loadingEmail">${emailTo}</span>...</strong></p>
                        <p class="text-muted mb-3">Please wait while we send your email.</p>
                        <div class="progress mb-2" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                 role="progressbar" 
                                 style="width: 100%" 
                                 aria-valuenow="100" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                Sending...
                            </div>
                        </div>
                        <div class="loading-details mt-3">
                            <p class="mb-0"><i class="bi bi-clock"></i> <small>Check the terminal/console for detailed sending progress</small></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existing = document.getElementById('emailLoadingOverlay');
    if (existing) {
        existing.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Prevent body scroll
    document.body.style.overflow = 'hidden';
}

// Hide loading modal
function hideEmailLoadingModal() {
    const overlay = document.getElementById('emailLoadingOverlay');
    if (overlay) {
        overlay.remove();
    }
    document.body.style.overflow = '';
}

// Add form submit handler
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[method="POST"]');
    const sendBtn = document.getElementById('sendEmailBtn');
    
    if (form && sendBtn) {
        form.addEventListener('submit', function(e) {
            const emailTo = document.getElementById('email_to').value || 'recipient';
            
            // Show loading modal
            showEmailLoadingModal(emailTo);
            
            // Disable submit button to prevent double submission
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
        });
    }
});
</script>
{% endblock %}

